# App Runner コスト削減案

## 問題点

以前の試算では「AWS（App Runner + RDS）: ¥3,500〜5,500/月」と見積もっていましたが、実際の設定では**約 173 USD/月（約 26,000 円/月）**となっており、大きな差があります。

## 原因分析

### 以前の試算の前提（推測）

- より小さいインスタンスサイズ（0.25 vCPU、0.5 GB など）
- 開発環境を 24 時間稼働させない想定
- 最小インスタンス数を 0 に設定

### 現在の実際の設定

- **本番環境**: 1 vCPU、2 GB、24 時間稼働 → 約 85 USD/月
- **開発環境**: 1 vCPU、2 GB、24 時間稼働 → 約 85 USD/月
- **自動デプロイ**: 2 USD/月
- **合計**: 約 173 USD/月（約 26,000 円/月）

## コスト削減案

### 削減案 1: インスタンスサイズを小さくする

**変更内容**:

- 1 vCPU、2 GB → **0.25 vCPU、0.5 GB**

**料金比較**:

| 設定                        | vCPU 料金   | メモリ料金 | 合計/時間   | 月額（24 時間稼働） |
| --------------------------- | ----------- | ---------- | ----------- | ------------------- |
| 現在（1 vCPU、2 GB）        | 0.081 USD   | 0.018 USD  | 0.099 USD   | 約 85 USD           |
| 削減案（0.25 vCPU、0.5 GB） | 0.02025 USD | 0.0045 USD | 0.02475 USD | 約 18 USD           |

**削減効果**:

- 本番環境: 85 USD → 18 USD（削減: 67 USD/月）
- 開発環境: 85 USD → 18 USD（削減: 67 USD/月）
- **合計削減: 約 134 USD/月（約 20,000 円/月）**

**注意点**:

- パフォーマンスが低下する可能性
- メモリが 0.5 GB と小さいため、メモリ不足のリスクあり
- 本番環境では慎重に検討が必要

---

### 削減案 2: 開発環境を停止可能にする

**変更内容**:

- 開発環境を 24 時間稼働 → **使用時のみ起動（1 日 8 時間想定）**

**料金比較**:

| 環境     | 現在（24 時間稼働） | 削減案（8 時間/日） | 削減額       |
| -------- | ------------------- | ------------------- | ------------ |
| 開発環境 | 約 85 USD/月        | 約 28 USD/月        | 約 57 USD/月 |

**削減効果**:

- **約 57 USD/月（約 8,500 円/月）の削減**

**注意点**:

- コールドスタートが発生する可能性（初回アクセス時に遅延）
- 使用時のみ手動で起動する必要がある

---

### 削減案 3: 組み合わせ（推奨）

**変更内容**:

- 本番環境: 0.25 vCPU、0.5 GB、24 時間稼働
- 開発環境: 0.25 vCPU、0.5 GB、8 時間/日稼働（または停止可能）

**料金計算**:

- **本番環境**: 0.02475 USD/時間 × 730 時間 = 約 18 USD/月
- **開発環境**: 0.02475 USD/時間 × 240 時間（8 時間/日） = 約 6 USD/月
- **自動デプロイ**: 2 USD/月
- **合計**: 約 26 USD/月（約 3,900 円/月）

**削減効果**:

- **約 147 USD/月（約 22,000 円/月）の削減**
- 以前の試算（¥3,500〜5,500/月）に近い金額

---

### 削減案 4: 最小インスタンス数を 0 に設定

**変更内容**:

- 最小インスタンス数を 0 に設定
- アクセスがない場合は自動的にスケールダウンして 0 になる

**料金計算**:

- アクセスがない時間は課金されない
- アクセスがある時間のみ課金

**注意点**:

- コールドスタートが発生（初回アクセス時に数秒〜数十秒の遅延）
- 本番環境ではユーザー体験に影響する可能性

---

## 推奨案

### 段階的な削減（推奨）

1. **まず開発環境を削減**

   - 開発環境: 0.25 vCPU、0.5 GB、8 時間/日稼働
   - 削減額: 約 79 USD/月（約 12,000 円/月）

2. **本番環境のパフォーマンスを確認**

   - 本番環境: 0.25 vCPU、0.5 GB に変更してテスト
   - パフォーマンスに問題がなければ継続

3. **最終的な目標**
   - 本番: 0.25 vCPU、0.5 GB、24 時間稼働 → 約 18 USD/月
   - 開発: 0.25 vCPU、0.5 GB、8 時間/日稼働 → 約 6 USD/月
   - 合計: 約 26 USD/月（約 3,900 円/月）

---

## 実装方法

### インスタンスサイズの変更

```bash
# App Runnerサービスの設定を更新
aws apprunner update-service \
  --service-arn <SERVICE_ARN> \
  --instance-configuration '{
    "Cpu": "256",
    "Memory": "512"
  }'
```

**注意**:

- Cpu: "256" = 0.25 vCPU
- Memory: "512" = 0.5 GB

### 開発環境の停止

```bash
# 開発環境を一時停止
aws apprunner pause-service \
  --service-arn <DEV_SERVICE_ARN>

# 再開
aws apprunner resume-service \
  --service-arn <DEV_SERVICE_ARN>
```

---

## まとめ

| 案                       | 月額料金                   | 削減額     | 注意点                            |
| ------------------------ | -------------------------- | ---------- | --------------------------------- |
| 現在                     | 約 173 USD（約 26,000 円） | -          | -                                 |
| 削減案 1（サイズ縮小）   | 約 36 USD（約 5,400 円）   | 約 137 USD | パフォーマンス低下の可能性        |
| 削減案 2（開発環境停止） | 約 116 USD（約 17,400 円） | 約 57 USD  | コールドスタート                  |
| 削減案 3（組み合わせ）   | 約 26 USD（約 3,900 円）   | 約 147 USD | パフォーマンス + コールドスタート |
| 削減案 4（最小 0）       | 変動                       | 変動       | コールドスタート                  |

**推奨**: 削減案 3（組み合わせ）で、以前の試算に近い金額（¥3,500〜5,500/月）を実現できます。
