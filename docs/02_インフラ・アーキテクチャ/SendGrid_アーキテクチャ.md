# SendGrid メール送信アーキテクチャ

## 📋 概要

PRO WORKS では、ユーザー認証に関するメール送信に **SendGrid** を使用しています。
このドキュメントでは、システム構成とデータフローを説明します。

---

## 🏗️ システム構成図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              PRO WORKS システム                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────┐      ┌─────────────────┐      ┌─────────────────┐
│   ユーザー   │──────│   Cloud Run     │──────│   SendGrid      │
│  (ブラウザ)  │      │  (Next.js App)  │      │  (メール配信)    │
└─────────────┘      └─────────────────┘      └─────────────────┘
       │                     │                        │
       │  1. サインアップ     │                        │
       │─────────────────────>│                        │
       │                     │                        │
       │                     │  2. API リクエスト      │
       │                     │───────────────────────>│
       │                     │                        │
       │                     │  3. レスポンス (202)    │
       │                     │<───────────────────────│
       │                     │                        │
       │                     │                        │  4. メール送信
       │                     │                        │──────────────>  📧
       │                     │                        │
       │  5. 確認メール受信   │                        │
       │<─────────────────────────────────────────────│
       │                     │                        │
       │  6. リンククリック   │                        │
       │─────────────────────>│                        │
       │                     │                        │
       │  7. 認証完了         │                        │
       │<─────────────────────│                        │
       │                     │                        │
```

---

## 📦 コンポーネント構成

### 1. アプリケーション側（Cloud Run）

```
proworks-app/
├── lib/
│   ├── email.ts          # SendGrid メール送信ユーティリティ
│   └── auth.ts           # Better Auth 設定（メール送信コールバック）
│
└── app/api/auth/
    ├── forgot-password/  # パスワードリセット API
    ├── change-email/     # メールアドレス変更 API
    └── [...all]/         # Better Auth ハンドラー
```

### 2. SendGrid 側

| コンポーネント | 役割 |
|--------------|------|
| Web API v3 | メール送信リクエストを受け付け |
| 送信キュー | メールを順次処理 |
| 配信エンジン | 実際のメール配信を実行 |
| バウンス処理 | 配信失敗時のハンドリング |

---

## 🔄 データフロー詳細

### シーケンス 1: 新規登録時のメール認証

```
┌────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌────────┐
│ ユーザー │     │ Frontend │     │ Backend  │     │ SendGrid │     │ メール  │
└────┬───┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └───┬────┘
     │              │               │               │               │
     │ フォーム入力  │               │               │               │
     │─────────────>│               │               │               │
     │              │               │               │               │
     │              │ POST /api/auth/signup-with-email               │
     │              │──────────────>│               │               │
     │              │               │               │               │
     │              │               │ ユーザー作成   │               │
     │              │               │ (Cloud SQL)   │               │
     │              │               │               │               │
     │              │               │ Better Auth   │               │
     │              │               │ sendVerificationEmail()       │
     │              │               │               │               │
     │              │               │ sgMail.send() │               │
     │              │               │──────────────>│               │
     │              │               │               │               │
     │              │               │ 202 Accepted  │               │
     │              │               │<──────────────│               │
     │              │               │               │               │
     │              │               │               │ SMTP 配信     │
     │              │               │               │──────────────>│
     │              │               │               │               │
     │              │ 200 OK        │               │               │
     │              │<──────────────│               │               │
     │              │               │               │               │
     │ 完了画面表示  │               │               │               │
     │<─────────────│               │               │               │
     │              │               │               │               │
     │              │               │               │ メール受信    │
     │<─────────────────────────────────────────────────────────────│
     │              │               │               │               │
```

### シーケンス 2: パスワードリセット

```
┌────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ ユーザー │     │ Frontend │     │ Backend  │     │ SendGrid │
└────┬───┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │              │               │               │
     │ メール入力   │               │               │
     │─────────────>│               │               │
     │              │               │               │
     │              │ POST /api/auth/forgot-password │
     │              │──────────────>│               │
     │              │               │               │
     │              │               │ auth.api.forgetPassword()
     │              │               │               │
     │              │               │ sendPasswordResetEmail()
     │              │               │──────────────>│
     │              │               │               │
     │              │ 200 OK        │               │
     │              │<──────────────│               │
     │              │               │               │
     │ 送信完了表示  │               │               │
     │<─────────────│               │               │
     │              │               │               │
```

---

## 📨 SendGrid API リクエスト/レスポンス

### リクエスト例

```typescript
// lib/email.ts での実装
const msg = {
  to: "user@example.com",
  from: "PRO WORKS <noreply@proworks.jp>",
  subject: "【PRO WORKS】メールアドレスの確認",
  text: "以下のリンクをクリックして...",
  html: "<html>...</html>",
};

await sgMail.send(msg);
```

### HTTP リクエスト（内部で送信される）

```http
POST https://api.sendgrid.com/v3/mail/send
Authorization: Bearer SG.xxxxxxxx
Content-Type: application/json

{
  "personalizations": [
    {
      "to": [{ "email": "user@example.com" }]
    }
  ],
  "from": {
    "email": "noreply@proworks.jp",
    "name": "PRO WORKS"
  },
  "subject": "【PRO WORKS】メールアドレスの確認",
  "content": [
    { "type": "text/plain", "value": "以下のリンクをクリックして..." },
    { "type": "text/html", "value": "<html>...</html>" }
  ]
}
```

### レスポンス

```http
HTTP/1.1 202 Accepted
X-Message-Id: abc123...
```

| ステータス | 意味 |
|-----------|------|
| 202 | 送信リクエスト受付成功（非同期で配信） |
| 400 | リクエスト形式エラー |
| 401 | 認証エラー（API キー無効） |
| 403 | 権限エラー（送信元ドメイン未認証等） |
| 429 | レート制限超過 |

---

## 🔐 セキュリティ

### API キー管理

```
┌─────────────────────────────────────────────────────────────────┐
│                     GitHub Secrets                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  SENDGRID_API_KEY = SG.xxxxxxxxxxxxxxxxxxxxxxxx         │   │
│  │  EMAIL_FROM = PRO WORKS <noreply@proworks.jp>           │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Cloud Run 環境変数                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  process.env.SENDGRID_API_KEY                           │   │
│  │  process.env.EMAIL_FROM                                 │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### ドメイン認証（SPF/DKIM/DMARC）

```
proworks.jp DNS レコード
─────────────────────────────────────────────────────────────────
TXT  @           v=spf1 include:sendgrid.net ~all
TXT  s1._domainkey   k=rsa; p=MIIBIjAN...（DKIM公開鍵）
TXT  _dmarc      v=DMARC1; p=quarantine; rua=mailto:...
─────────────────────────────────────────────────────────────────
```

---

## 📊 メール種別一覧

| 種別 | トリガー | 送信先 | テンプレート |
|------|---------|--------|-------------|
| メールアドレス確認 | 新規登録 | 登録メールアドレス | `sendVerificationEmail()` |
| パスワードリセット | パスワード忘れ | 登録メールアドレス | `sendPasswordResetEmail()` |
| メールアドレス変更確認 | メールアドレス変更 | **新しい**メールアドレス | `sendEmailChangeVerificationEmail()` |

---

## 🔧 環境別動作

### 開発環境（ローカル）

```typescript
// NODE_ENV === "development" の場合
// メールは送信されず、コンソールに出力される

================================================================================
📧 【PRO WORKS】メールアドレスの確認
================================================================================
宛先: user@example.com

以下のリンクをクリックして、操作を完了してください。

▶ http://localhost:3000/api/auth/verify-email?token=xxx...

※ このリンクの有効期限は1時間です。
================================================================================
```

### 本番環境（Cloud Run）

```typescript
// NODE_ENV === "production" の場合
// SendGrid API を使用して実際にメール送信

✅ メール送信成功: user@example.com - 【PRO WORKS】メールアドレスの確認
```

---

## ⚠️ エラーハンドリング

### エラー発生時のフロー

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Backend   │────>│  SendGrid   │────>│  エラー発生  │
└─────────────┘     └─────────────┘     └─────────────┘
                                              │
                                              ▼
                    ┌─────────────────────────────────────┐
                    │  エラーログ出力                      │
                    │  ❌ SendGrid メール送信エラー: ...   │
                    │  SendGrid エラー詳細: { ... }       │
                    └─────────────────────────────────────┘
                                              │
                                              ▼
                    ┌─────────────────────────────────────┐
                    │  ユーザーへのレスポンス              │
                    │  { success: false, error: "..." }   │
                    └─────────────────────────────────────┘
```

### 主なエラーと対処

| エラー | 原因 | 対処 |
|--------|------|------|
| 401 Unauthorized | API キー無効 | GitHub Secrets を確認 |
| 403 Forbidden | 送信元ドメイン未認証 | SendGrid でドメイン認証を設定 |
| 429 Too Many Requests | レート制限 | 送信頻度を下げる |
| Network Error | 接続エラー | リトライ処理を検討 |

---

## 📈 モニタリング

### SendGrid ダッシュボードで確認できる項目

| 項目 | 説明 |
|------|------|
| Delivered | 正常に配信されたメール数 |
| Opens | 開封されたメール数 |
| Clicks | リンクがクリックされた数 |
| Bounces | 配信失敗（アドレス不正等） |
| Spam Reports | 迷惑メール報告数 |

### Cloud Run ログでの確認

```bash
# メール送信ログを確認
gcloud run services logs read proworks-prod \
  --region asia-northeast1 \
  --filter "メール送信"
```

---

## 🚀 セットアップ手順

### 1. SendGrid アカウント作成

1. https://sendgrid.com にアクセス
2. 無料アカウントを作成
3. API キーを発行（Settings → API Keys → Create API Key）

### 2. ドメイン認証

1. Settings → Sender Authentication
2. ドメインを追加
3. DNS レコードを設定（SPF, DKIM）
4. 認証完了を確認

### 3. GitHub Secrets 設定

```
SENDGRID_API_KEY = SG.xxxxxxxxxxxxxxxxxxxxxxxx
EMAIL_FROM = PRO WORKS <noreply@proworks.jp>
```

### 4. デプロイ

```bash
git push origin main  # 自動デプロイ
```

---

## 📚 参考リンク

- [SendGrid 公式ドキュメント](https://docs.sendgrid.com/)
- [SendGrid Node.js SDK](https://github.com/sendgrid/sendgrid-nodejs)
- [SendGrid Web API v3](https://docs.sendgrid.com/api-reference/mail-send/mail-send)
- [ドメイン認証ガイド](https://docs.sendgrid.com/ui/account-and-settings/how-to-set-up-domain-authentication)

---

*作成日: 2025年12月*
*対象: PRO WORKS メール認証機能*

