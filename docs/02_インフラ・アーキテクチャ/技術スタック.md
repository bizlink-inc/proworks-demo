# 🚀 ProWorks 技術スタック（AWS 版 v2.0）

## 1. システム構成概要

```
【フロントエンド】
Next.js 16 + React + TypeScript + Tailwind CSS
↓ API通信
【BFF層（Route Handlers / API Routes）】
Next.js 内部API層（Better Auth認証・kintone連携を仲介）
↓
【バックエンド】
kintone REST API（業務データ管理）
＋
AWS App Runner（Next.js/Better Authホスティング）
＋
Amazon RDS PostgreSQL（認証・セッション・ユーザー情報管理）
＋
Amazon SES（メール送信）
```

---

## 2. 採用技術スタック一覧

### フロントエンド

| 技術            | 用途                               | 選定理由                                                              |
| --------------- | ---------------------------------- | --------------------------------------------------------------------- |
| **Next.js 16**  | Web アプリケーションフレームワーク | 最新の Turbopack・キャッシュ機構対応。React 19 対応済み。高速・安定。 |
| React 19        | UI 構築ライブラリ                  | 業界標準で保守性が高い。最新の並行レンダリング対応。                  |
| TypeScript      | 型付き言語                         | 型安全によりバグを早期防止。中長期開発に適する。                      |
| Tailwind CSS    | CSS フレームワーク                 | デザイン統一と開発効率を両立。                                        |
| **Better Auth** | 認証ライブラリ                     | Auth.js の後継。軽量・柔軟で PostgreSQL との親和性が高い。            |

---

### バックエンド

| 技術                                 | 用途                             | 選定理由                                                                  |
| ------------------------------------ | -------------------------------- | ------------------------------------------------------------------------- |
| **AWS App Runner（東京リージョン）** | Next.js/Better Auth ホスティング | コンテナベースの自動スケール。GitHub との連携が容易。国内リージョン対応。 |
| **Amazon RDS PostgreSQL**            | 認証・セッション DB              | マネージドサービスで運用負荷が低い。自動バックアップ・高可用性構成。      |
| **Amazon SES**                       | メール送信サービス               | 完全従量課金で低コスト。高い到達率とスケーラビリティ。                    |
| **kintone REST API**                 | 業務データ永続化・管理           | 既存社内知見を活用し、管理 UI 開発を不要化。                              |
| **@kintone/rest-api-client**         | kintone 接続ライブラリ           | 公式ライブラリで信頼性・型安全性が高い。                                  |
| **@aws-sdk/client-ses**              | SES 接続ライブラリ               | AWS 公式 SDK で型安全性が高い。                                           |

---

### インフラ・ホスティング

| 技術                    | 用途                   | 選定理由                                                       |
| ----------------------- | ---------------------- | -------------------------------------------------------------- |
| **AWS App Runner**      | コンテナホスティング   | 自動スケール・デプロイ。国内リージョン対応。コスト効率が高い。 |
| **Amazon ECR**          | コンテナレジストリ     | App Runner とのシームレスな連携。セキュアなイメージ管理。      |
| **Amazon RDS**          | マネージドデータベース | 自動バックアップ・パッチ適用。Multi-AZ 構成で高可用性。        |
| **Amazon SES**          | メール送信             | 完全従量課金（$0.10/1,000 通）で大幅なコスト削減。             |
| **AWS Secrets Manager** | シークレット管理       | API キー・DB 認証情報を安全に保持。自動ローテーション対応。    |
| **Amazon CloudWatch**   | 監視・ログ             | アプリケーションログ・メトリクス・アラート通知。               |
| **GitHub Actions**      | CI/CD パイプライン     | ソース管理とデプロイの自動化。                                 |

---

### AI・外部サービス

| 技術           | 用途           | 選定理由                                             |
| -------------- | -------------- | ---------------------------------------------------- |
| **Gemini API** | AI マッチング  | 案件と人材のマッチングスコア計算。コスト効率が高い。 |
| **kintone**    | 業務データ管理 | 案件・人材・応募履歴の一元管理。                     |

---

### セキュリティ

| 対策                 | 実装方法                     | 目的                                       |
| -------------------- | ---------------------------- | ------------------------------------------ |
| HTTPS 通信           | ALB + App Runner 標準対応    | 通信の暗号化                               |
| 認証データ管理       | Better Auth + RDS PostgreSQL | セッション・パスワードを安全に分離管理     |
| kintone 接続         | API Token + ドメイン制限     | 外部アクセス制御                           |
| 環境変数管理         | AWS Secrets Manager          | API キー等を安全に保持・自動ローテーション |
| セッション管理       | JWT + 有効期限付き Cookie    | 不正アクセス防止                           |
| VPC 設定             | Private Subnet for RDS       | データベースへの直接アクセス防止           |
| IAM Role             | App Runner 用 IAM ロール     | 最小権限の原則（SES 送信権限のみ）         |
| セキュリティグループ | RDS・App Runner 間の通信制限 | 不要なポート閉鎖                           |

---

## 3. システムアーキテクチャ概要

```
[ユーザー]
   ↓
[Application Load Balancer]
   ↓
[Next.js (AWS App Runner)]
 ├─ UI (React, Tailwind)
 ├─ Better Auth (RDS PostgreSQL)
 ├─ API Routes（BFF層）
 └─ Email Service (Amazon SES)
        ↓
    [kintone REST API]
        ↓
    [kintoneアプリ群]
```

- kintone には認証情報を保存せず、`external_user_id`（外部参照キー）のみ保持。
- 認証・セッション情報は RDS PostgreSQL 側で管理し、データ安全性とスケーラビリティを確保。
- メール送信は Amazon SES を使用し、完全従量課金で大幅なコスト削減を実現。
- kintone は業務データ管理に専念し、バックオフィスのメンテナンス性を高める。

---

## 4. kintone アプリ構成

| アプリ名           | 概要                     | 主な項目                                   |
| ------------------ | ------------------------ | ------------------------------------------ |
| **案件マスタ**     | 案件情報を一元管理       | 案件名、企業名、単価、公開フラグ           |
| **人材マスタ**     | 登録エンジニア情報を管理 | 名前、スキル、ステータス、external_user_id |
| **応募履歴**       | 案件と人材の紐付け管理   | 案件 ID、人材 ID、ステータス、メモ         |
| **レコメンド履歴** | AI マッチング結果の保存  | 人材 ID、案件 ID、スコア、送信日時         |

※ kintone API の 1 日あたりのリクエスト上限は、**1 アプリにつき 10,000 回**（2025 年現在）

---

## 5. セキュリティ設計

| 項目           | 実装                                | リスク軽減効果                           |
| -------------- | ----------------------------------- | ---------------------------------------- |
| 通信暗号化     | HTTPS (TLS1.3)                      | 通信傍受を防止                           |
| 認証情報分離   | kintone 非保存・RDS PostgreSQL 管理 | パスワード漏洩リスクを回避               |
| セッション     | JWT + Cookie                        | 不正ログイン防止                         |
| API キー管理   | AWS Secrets Manager                 | 認証情報の安全な保管・自動ローテーション |
| VPC 設定       | Private Subnet                      | RDS への直接アクセス防止                 |
| IAM Role       | 最小権限の原則                      | App Runner に SES 送信権限のみ付与       |
| CORS 制御      | App Runner + kintone 設定           | 外部からの不正呼び出し防止               |
| メール送信認証 | SES Domain Verification             | なりすましメール防止                     |

**準拠規格**

- 個人情報保護法
- ISO27001（kintone）
- SOC 2 Type II（AWS）
- GDPR 対応（Amazon SES）

---

## 6. リスクと対策

| リスク                 | 影響度 | 発生確率       | 対策                                                                          |
| ---------------------- | ------ | -------------- | ----------------------------------------------------------------------------- |
| kintone API 制限到達   | 中     | 低             | 1 アプリあたり 1 日 10,000 リクエストを上限とし、キャッシュ・バッチ処理を適用 |
| App Runner 料金超過    | 低     | 低             | CloudWatch Alarms で費用警告設定。Auto Scaling で最適化。                     |
| DB スキーマ変更        | 中     | 中             | Drizzle ORM によるマイグレーション管理                                        |
| システム障害           | 高     | 低             | CloudWatch Logs + Alarms で早期検知。Multi-AZ 構成で高可用性確保。            |
| メール送信失敗         | 中     | 低             | SES 送信ステータス監視。バウンス・苦情率の定期チェック。                      |
| SES サンドボックス制限 | 高     | 中（初期のみ） | 本番前に Production Access 申請を完了。                                       |

---

## 7. GCP 構成からの主な変更点

| 項目                 | GCP 構成                | AWS 構成                   | 変更理由                         |
| -------------------- | ----------------------- | -------------------------- | -------------------------------- |
| コンテナホスティング | Cloud Run               | **App Runner**             | コスト効率・デプロイの簡便性     |
| データベース         | Cloud SQL PostgreSQL    | **RDS PostgreSQL**         | 統一された AWS エコシステム      |
| メール送信           | SendGrid（¥3,000〜/月） | **Amazon SES（¥18〜/月）** | **大幅なコスト削減（約 95%減）** |
| シークレット管理     | Secret Manager          | **Secrets Manager**        | 統一された AWS エコシステム      |
| 監視・ログ           | Cloud Logging           | **CloudWatch**             | 統一された AWS エコシステム      |
| コンテナレジストリ   | Artifact Registry       | **ECR**                    | 統一された AWS エコシステム      |

---

## 8. コスト比較サマリー

| 項目                   | GCP + SendGrid    | AWS + SES         | 差額           |
| ---------------------- | ----------------- | ----------------- | -------------- |
| コンピュート           | ¥2,000〜4,000     | ¥3,500〜5,500     | +¥1,500〜1,500 |
| データベース           | ¥1,000〜2,000     | ¥1,500〜2,500     | +¥500〜500     |
| メール送信（1,000 人） | ¥3,000            | **¥180**          | **-¥2,820**    |
| **合計（1,000 人）**   | **¥6,000〜9,000** | **¥5,180〜8,180** | **-¥820〜820** |

**結論**: メール送信コストの大幅削減により、AWS 構成の方が**約 10〜15%安い**

詳細は `メール送信数_月間コスト試算.md` を参照。

---

## 9. まとめ

**本構成の強み**

1. **Next.js 16 採用による将来互換性・高速化**
2. **Better Auth + RDS PostgreSQL による安全な認証管理**
3. **App Runner + kintone による国内安定通信構成**
4. **Amazon SES による大幅なメール送信コスト削減（約 95%減）**
5. **統一された AWS エコシステムによる運用効率化**
6. **CloudWatch による包括的な監視・ログ管理**

**推奨アクション**

1. AWS 環境のセットアップ（App Runner、RDS、SES）
2. Amazon SES の Production Access 申請
3. ドメイン認証設定（SPF、DKIM、DMARC）
4. GitHub Actions での CI/CD パイプライン構築
5. 既存コードの SES 対応（SendGrid → SES 移行）

---

**作成日**：2025 年 12 月  
**作成者**：佐藤（開発担当）  
**バージョン**：2.0（AWS 版）  
**前バージョン**：1.3（GCP 版）
