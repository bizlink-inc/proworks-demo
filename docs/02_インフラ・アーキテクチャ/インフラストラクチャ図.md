# PROWORKS インフラ構成図（AWS）

## サイトマップ × インフラ構成

```mermaid
graph TD
    subgraph WP["🟢 WordPress（EC2）"]
        FP["🟨 フロントページ"]
        FP --> MEDIA["メディアコンテンツ"]
        FP --> CORP["企業ページ"]
        FP --> FRONT_JOBS["フロント案件/ログイン"]
        MEDIA --> M1["キャリアとスキル"]
        MEDIA --> M2["ビジネス知識"]
        MEDIA --> M3["みんなの声"]
        MEDIA --> M4["PRO WORKSニュース"]
        MEDIA --> M5["ライフ"]
        MEDIA --> M6["AI・テクノロジー"]
        CORP --> CONTACT["問い合わせ・資料請求"]
    end

    subgraph NJ["🟠 Next.js（App Runner）"]
        FRONT_JOBS --> REG["新規登録"]
        FRONT_JOBS --> LOGINSC["ログイン画面"]
        REG --> MAIL["メール送信（Amazon SES）"]
        MAIL --> MP1["マイページ"]
        LOGINSC --> JOBS["案件一覧"]
        JOBS --> MP2["マイページ"]
        JOBS --> APPLIED["応募済み案件"]
        MP1 --> PROFILE["プロフィール"]
        MP1 --> CAREER["職歴・資格"]
        MP1 --> PREF["希望条件"]
    end

    NJ --> PG["🟡 RDS PostgreSQL"]
    NJ --> Kintone["🔵 kintone"]
    NJ --> SES["📧 Amazon SES"]

    style FP fill:#E5A12B,color:#fff
```

---

## インフラ構成（詳細版）

```mermaid
graph TD
    User["👥 ユーザー"]
    User --> ALB["⚙️ Application Load Balancer"]
    ALB --> WP["🟢 EC2<br/>WordPress"]
    ALB --> AR["🟠 App Runner<br/>Next.js"]
    AR --> RDS["🟡 RDS PostgreSQL"]
    AR --> Kintone["🔵 kintone API"]
    AR --> SES["📧 Amazon SES"]
    AR --> Gemini["🤖 Gemini API"]

    subgraph AWS["AWS クラウド"]
        ALB
        WP
        AR
        RDS
        SES
        ECR["📦 ECR<br/>Container Registry"]
        Secrets["🔐 Secrets Manager"]
        CloudWatch["📊 CloudWatch<br/>Logs & Metrics"]
    end

    AR --> ECR
    AR --> Secrets
    AR --> CloudWatch

    GitHub["💻 GitHub Actions"] --> ECR
    GitHub --> AR

    style WP fill:#34A853,color:#fff
    style AR fill:#FF9900,color:#fff
    style RDS fill:#527FFF,color:#fff
    style SES fill:#DD344C,color:#fff
```

---

## システムアーキテクチャ詳細

```mermaid
graph LR
    subgraph Client["クライアント"]
        Browser["🌐 ブラウザ"]
    end

    subgraph AWS["AWS インフラ"]
        ALB["Application Load Balancer"]

        subgraph AppRunner["App Runner"]
            NextJS["Next.js 16<br/>+ React 19<br/>+ TypeScript"]
            BetterAuth["Better Auth<br/>認証管理"]
            API["API Routes<br/>BFF層"]
        end

        subgraph Database["データベース"]
            RDS["RDS PostgreSQL<br/>認証・セッション"]
        end

        subgraph Email["メール送信"]
            SES["Amazon SES<br/>トランザクションメール"]
        end

        subgraph Monitoring["監視・ログ"]
            CloudWatch["CloudWatch<br/>Logs & Metrics"]
        end

        subgraph Security["セキュリティ"]
            Secrets["Secrets Manager<br/>APIキー管理"]
        end
    end

    subgraph External["外部サービス"]
        Kintone["kintone<br/>業務データ管理"]
        Gemini["Gemini API<br/>AIマッチング"]
    end

    Browser --> ALB
    ALB --> NextJS
    NextJS --> BetterAuth
    NextJS --> API
    BetterAuth --> RDS
    API --> Kintone
    API --> Gemini
    NextJS --> SES
    NextJS --> CloudWatch
    NextJS --> Secrets
```

---

## 担当範囲

| 領域           | サービス                      | 内容                                                        |
| -------------- | ----------------------------- | ----------------------------------------------------------- |
| **WordPress**  | EC2 (MySQL 内蔵)              | フロント LP・フロント案件・メディア・企業ページ・問い合わせ |
| **Next.js**    | App Runner + RDS (PostgreSQL) | 新規登録・ログイン・案件一覧・マイページ・応募              |
| **メール送信** | Amazon SES                    | 認証メール・通知メール・パスワードリセット                  |
| **kintone**    | SaaS                          | 案件マスタ・人材マスタ・応募履歴                            |
| **AI 機能**    | Gemini API                    | 案件と人材のマッチングスコア計算                            |

---

## データフロー

### 1. ユーザー登録フロー

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant AR as App Runner
    participant RDS as RDS PostgreSQL
    participant SES as Amazon SES

    User->>AR: 登録情報送信
    AR->>RDS: ユーザー情報保存
    AR->>SES: 確認メール送信
    SES->>User: メール受信
    User->>AR: 確認リンククリック
    AR->>RDS: メール確認済みに更新
    AR->>User: ログイン完了
```

### 2. 案件検索・応募フロー

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant AR as App Runner
    participant RDS as RDS PostgreSQL
    participant Kintone as kintone
    participant Gemini as Gemini API

    User->>AR: 案件検索リクエスト
    AR->>RDS: セッション確認
    AR->>Kintone: 案件データ取得
    AR->>Kintone: 人材データ取得
    AR->>Gemini: マッチングスコア計算
    Gemini->>AR: スコア返却
    AR->>User: 案件一覧表示（スコア順）
    User->>AR: 案件応募
    AR->>Kintone: 応募履歴登録
    AR->>User: 応募完了
```

---

## 環境変数一覧

### AWS 関連

| 変数名         | 説明           | 例                                    |
| -------------- | -------------- | ------------------------------------- |
| `AWS_REGION`   | AWS リージョン | `ap-northeast-1`                      |
| `DATABASE_URL` | RDS 接続文字列 | `postgresql://user:pass@host:5432/db` |

### Amazon SES 関連

| 変数名                  | 説明                 | 例                                |
| ----------------------- | -------------------- | --------------------------------- |
| `AWS_SES_REGION`        | SES リージョン       | `ap-northeast-1`                  |
| `AWS_ACCESS_KEY_ID`     | AWS 認証情報         | `AKIA...`                         |
| `AWS_SECRET_ACCESS_KEY` | AWS 認証情報         | `secret...`                       |
| `EMAIL_FROM`            | 送信元メールアドレス | `PRO WORKS <noreply@proworks.jp>` |

### 認証関連

| 変数名                | 説明                 | 例                    |
| --------------------- | -------------------- | --------------------- |
| `BETTER_AUTH_SECRET`  | 認証シークレット     | `random-secret-key`   |
| `NEXT_PUBLIC_APP_URL` | アプリケーション URL | `https://proworks.jp` |

### kintone 関連

| 変数名                             | 説明                     | 例                           |
| ---------------------------------- | ------------------------ | ---------------------------- |
| `KINTONE_BASE_URL`                 | kintone ベース URL       | `https://example.cybozu.com` |
| `KINTONE_TALENT_APP_ID`            | 人材アプリ ID            | `123`                        |
| `KINTONE_TALENT_API_TOKEN`         | 人材アプリトークン       | `token...`                   |
| `KINTONE_JOB_APP_ID`               | 案件アプリ ID            | `456`                        |
| `KINTONE_JOB_API_TOKEN`            | 案件アプリトークン       | `token...`                   |
| `KINTONE_APPLICATION_APP_ID`       | 応募履歴アプリ ID        | `789`                        |
| `KINTONE_APPLICATION_API_TOKEN`    | 応募履歴アプリトークン   | `token...`                   |
| `KINTONE_RECOMMENDATION_APP_ID`    | レコメンドアプリ ID      | `101`                        |
| `KINTONE_RECOMMENDATION_API_TOKEN` | レコメンドアプリトークン | `token...`                   |

### Gemini API 関連

| 変数名           | 説明            | 例        |
| ---------------- | --------------- | --------- |
| `GEMINI_API_KEY` | Gemini API キー | `AIza...` |

---

## セキュリティ対策

| 対策           | 実装方法                     | 目的                                   |
| -------------- | ---------------------------- | -------------------------------------- |
| HTTPS 通信     | ALB + App Runner 標準対応    | 通信の暗号化                           |
| 認証データ管理 | Better Auth + RDS PostgreSQL | セッション・パスワードを安全に分離管理 |
| kintone 接続   | API Token + ドメイン制限     | 外部アクセス制御                       |
| 環境変数管理   | AWS Secrets Manager          | API キー等を安全に保持                 |
| セッション管理 | JWT + 有効期限付き Cookie    | 不正アクセス防止                       |
| VPC 設定       | Private Subnet for RDS       | データベースへの直接アクセス防止       |
| IAM Role       | App Runner 用 IAM ロール     | 最小権限の原則                         |

---

## 監視・ログ

| 項目                 | ツール             | 内容                      |
| -------------------- | ------------------ | ------------------------- |
| アプリケーションログ | CloudWatch Logs    | エラー・アクセスログ      |
| メトリクス           | CloudWatch Metrics | CPU・メモリ・リクエスト数 |
| アラート             | CloudWatch Alarms  | 異常検知時の通知          |
| メール送信状況       | SES Dashboard      | 送信成功率・バウンス率    |

---

_更新日: 2025 年 12 月_  
_対象: ProWorks AWS 構成_
