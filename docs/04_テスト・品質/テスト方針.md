# テスト戦略とCI/CD

## 概要

このプロジェクトでは、3層のテスト戦略を採用しています。

| レイヤー | ツール | 対象 | テスト数 |
|---------|--------|------|----------|
| APIテスト | Vitest | API Routes（認証、応募、案件、プロフィール、管理者） | 75件 |
| ユニットテスト | Vitest | Lambdaマッチングロジック | 11件 |
| E2Eテスト | Playwright | ユーザーフロー（ログイン、応募、管理者画面） | 25件 |

**合計: 111テスト**

---

## テストファイル構成

```
proworks-app/
├── tests/
│   ├── api/                          # APIテスト
│   │   ├── auth/
│   │   │   ├── signup.test.ts        # POST /api/auth/signup-with-email
│   │   │   ├── password-reset.test.ts # POST /api/auth/forgot-password
│   │   │   └── email-change.test.ts  # POST /api/auth/change-email
│   │   ├── me/
│   │   │   └── profile.test.ts       # GET/PATCH /api/me
│   │   ├── jobs/
│   │   │   └── jobs.test.ts          # GET /api/jobs, GET /api/jobs/[id]
│   │   ├── applications/
│   │   │   └── applications.test.ts  # POST/GET/PATCH /api/applications
│   │   └── admin/
│   │       └── admin.test.ts         # POST /api/admin/login, バッチ設定
│   ├── unit/
│   │   └── lambda/
│   │       └── matching.test.ts      # マッチングスコア計算
│   ├── e2e/                          # E2Eテスト
│   │   ├── auth.spec.ts              # 認証フロー
│   │   ├── profile.spec.ts           # プロフィール・応募履歴
│   │   ├── notifications.spec.ts     # 通知・案件一覧UI
│   │   └── admin.spec.ts             # 管理者画面
│   ├── mocks/                        # 共通モック
│   │   ├── kintone.ts
│   │   ├── ses.ts
│   │   └── slack.ts
│   ├── fixtures/                     # テストデータ
│   │   ├── users.ts
│   │   └── jobs.ts
│   └── helpers/                      # テストヘルパー
│       ├── auth.ts
│       └── api.ts
├── vitest.config.ts
└── playwright.config.ts
```

---

## テスト実行コマンド

### 基本コマンド（手法別）

```bash
# 全テスト実行
npm test

# ウォッチモード
npm run test:watch

# APIテストのみ
npm run test:api

# ユニットテストのみ
npm run test:unit

# E2Eテスト実行（ヘッドレス）
npm run test:e2e

# E2Eテスト（UIモード）
npm run test:e2e:ui

# カバレッジレポート生成
npm run test:coverage
```

### 機能別テストコマンド

機能ごとにテストを実行できます。コード変更時に関連テストだけ実行したい場合に便利です。

| コマンド | 対象機能 | 実行内容 |
|----------|----------|----------|
| `npm run test:auth` | 認証関連 | API + E2E |
| `npm run test:profile` | プロフィール | API + E2E |
| `npm run test:jobs` | 案件 | API |
| `npm run test:applications` | 応募 | API |
| `npm run test:admin` | 管理者 | API + E2E |
| `npm run test:lambda` | Lambdaバッチ処理 | Unit |
| `npm run test:notifications` | 通知UI | E2E |

```bash
# 例：認証周りのコードを変更した場合
npm run test:auth

# 例：案件APIを変更した場合
npm run test:jobs

# 例：Lambdaマッチングロジックを変更した場合
npm run test:lambda
```

---

## 機能別テストカバレッジ

以下の表は、各機能がAPIテストとE2Eテストでどのようにカバーされているかを示しています。

### 1. 認証関連（`npm run test:auth`）

| ID | テスト項目 | API | E2E |
|----|-----------|-----|-----|
| 1.1.1 | 正常な登録（必須項目入力） | ✅ | - |
| 1.1.3 | 既存メールアドレスでのエラー | ✅ | - |
| 1.1.4 | 無効なメールアドレス | ✅ | - |
| 1.3.1 | パスワードリセット申請 | ✅ | - |
| 1.4.1 | メールアドレス変更申請 | ✅ | - |
| - | ログインページ表示 | - | ✅ |
| - | 新規登録ページ表示 | - | ✅ |
| - | パスワードリセットページ表示 | - | ✅ |
| - | 未認証時のリダイレクト | - | ✅ |

**対象ファイル:**
- API: `tests/api/auth/signup.test.ts`, `password-reset.test.ts`, `email-change.test.ts`
- E2E: `tests/e2e/auth.spec.ts`

### 2. プロフィール関連（`npm run test:profile`）

| ID | テスト項目 | API | E2E |
|----|-----------|-----|-----|
| 2.1.1 | プロフィール取得 | ✅ | - |
| 2.1.2 | 退会済みユーザーのアクセス制御 | ✅ | - |
| 2.2.1 | 基本情報の更新 | ✅ | - |
| 2.2.2 | スキル情報の更新 | ✅ | - |
| 2.2.3 | 希望条件の更新 | ✅ | - |
| 2.2.5 | プロフィール完成時のSlack通知 | ✅ | - |
| - | 未認証時のプロフィールページアクセス拒否 | - | ✅ |
| - | 応募履歴ページへのアクセス制御 | - | ✅ |
| - | 退会ページへのアクセス制御 | - | ✅ |
| - | お問い合わせページ表示 | - | ✅ |

**対象ファイル:**
- API: `tests/api/me/profile.test.ts`
- E2E: `tests/e2e/profile.spec.ts`

### 3. 案件関連（`npm run test:jobs`）

| ID | テスト項目 | API | E2E |
|----|-----------|-----|-----|
| 3.1.1 | 全案件取得（クローズ除外） | ✅ | - |
| 3.1.2 | ページネーション（skip/limit） | ✅ | - |
| 3.1.3 | キーワード検索（AND検索） | ✅ | - |
| 3.1.4 | 職種フィルター | ✅ | - |
| 3.1.5 | リモート可否フィルター | ✅ | - |
| 3.1.6 | 勤務地フィルター | ✅ | - |
| 3.1.7 | 並び替え（新着順・単価順） | ✅ | - |
| 3.2.1 | 案件詳細取得 | ✅ | - |
| 3.2.2 | 存在しない案件のエラー処理 | ✅ | - |
| 3.3.1 | 応募済み案件の除外 | ✅ | - |
| 3.3.2 | クローズ案件の詳細表示 | ✅ | - |

**対象ファイル:**
- API: `tests/api/jobs/jobs.test.ts`

### 4. 応募関連（`npm run test:applications`）

| ID | テスト項目 | API | E2E |
|----|-----------|-----|-----|
| 4.1.1 | 案件への応募 | ✅ | - |
| 4.1.2 | 応募時のプロフィール未完了警告 | ✅ | - |
| 4.1.3 | 重複応募チェック | ✅ | - |
| 4.1.4 | 存在しない案件への応募エラー | ✅ | - |
| 4.2.1 | 応募履歴一覧取得 | ✅ | - |
| 4.3.1 | 応募取消し | ✅ | - |
| 4.3.2 | 取消し不可のケース（面談中） | ✅ | - |
| 4.3.3 | 存在しない応募のエラー処理 | ✅ | - |

**対象ファイル:**
- API: `tests/api/applications/applications.test.ts`

### 5. 管理者関連（`npm run test:admin`）

| ID | テスト項目 | API | E2E |
|----|-----------|-----|-----|
| 8.1.1 | 管理者ログイン（正常系） | ✅ | - |
| 8.1.2 | 管理者ログインバリデーション | ✅ | - |
| 8.4.1 | バッチ設定取得 | ✅ | - |
| 8.4.2 | バッチ設定更新 | ✅ | - |
| - | 管理者ログインページ表示 | - | ✅ |
| - | 未認証時のダッシュボードアクセス拒否 | - | ✅ |
| - | 未認証時のバッチ設定ページアクセス拒否 | - | ✅ |

**対象ファイル:**
- API: `tests/api/admin/admin.test.ts`
- E2E: `tests/e2e/admin.spec.ts`

### 6. Lambdaバッチ処理（`npm run test:lambda`）

| ID | テスト項目 | Unit |
|----|-----------|------|
| 10.1.1 | スキルマッチ計算 | ✅ |
| 10.1.2 | 職種マッチ計算 | ✅ |
| 10.1.3 | スコアゼロのケース | ✅ |
| 10.1.4 | 経験からのスコア加算 | ✅ |
| 10.1.5 | 複数ソースからのスコア加算 | ✅ |
| 10.1.6 | 返り値の構造検証 | ✅ |
| 10.2.1 | 閾値判定 | ✅ |
| 10.3 | 空データのハンドリング | ✅ |

**対象ファイル:**
- Unit: `tests/unit/lambda/matching.test.ts`

### 7. 通知UI関連（`npm run test:notifications`）

| ID | テスト項目 | E2E |
|----|-----------|-----|
| 9.1 | 通知ドロップダウン表示 | ✅ |
| 9.2 | お知らせバナー表示 | ✅ |
| 9.3 | 通知一覧ページ遷移 | ✅ |
| 3.1 | 案件一覧ページ表示 | ✅ |
| 3.2 | 案件詳細モーダル表示 | ✅ |

**対象ファイル:**
- E2E: `tests/e2e/notifications.spec.ts`

---

## APIテスト詳細

### 1. 認証API

#### POST /api/auth/signup-with-email（新規登録）
| テストケース | 説明 |
|-------------|------|
| 正常系：ユーザー登録 | 必須項目入力で登録成功 |
| 正常系：クッキー保存 | サインアップデータがクッキーに保存 |
| 正常系：rememberMe | ログイン保持クッキーが設定される |
| 異常系：既存メール | 400エラー（重複登録） |
| 異常系：空メール | 400エラー（バリデーション） |
| 異常系：予期しないエラー | 500エラー |

#### POST /api/auth/forgot-password（パスワードリセット）
| テストケース | 説明 |
|-------------|------|
| 正常系：リセット申請 | メール送信成功 |
| セキュリティ：存在しないメール | 成功メッセージ（情報漏洩防止） |
| セキュリティ：内部エラー | 成功メッセージ（情報漏洩防止） |
| 異常系：空メール | 400エラー |

#### POST /api/auth/change-email（メールアドレス変更）
| テストケース | 説明 |
|-------------|------|
| 正常系：変更申請 | 確認メール送信 |
| 異常系：未認証 | 401エラー |
| 異常系：パスワード未入力 | 400エラー |
| 異常系：無効なメール形式 | 400エラー |
| 異常系：同一メール | 400エラー |
| 異常系：パスワード不一致 | 400エラー |

### 2. プロフィールAPI（GET/PATCH /api/me）

| テストケース | 説明 |
|-------------|------|
| GET 正常系 | プロフィール情報を返す |
| GET 退会済み | 403エラー（アカウント無効） |
| GET 未認証 | 401エラー |
| GET レコードなし | 404エラー |
| PATCH 正常系 | プロフィール更新成功 |
| PATCH スキル更新 | スキル情報のみ更新 |
| PATCH 希望条件更新 | 希望条件のみ更新 |
| PATCH プロフィール完成通知 | Slack通知送信 |
| PATCH 未認証 | 401エラー |

### 3. 案件API

#### GET /api/jobs（案件一覧）
| テストケース | 説明 |
|-------------|------|
| 全件取得 | クローズ案件除外で一覧取得 |
| 未認証取得 | 未認証でも取得可能 |
| ページネーション | skip/limit指定 |
| キーワード検索 | タイトル・スキル検索 |
| AND検索 | 複数キーワードAND条件 |
| 該当なし | 空配列を返す |
| 職種フィルター | ポジション絞り込み |
| リモートフィルター | リモート可否絞り込み |
| 勤務地フィルター | エリア絞り込み |
| 新着順ソート | 作成日時降順 |
| 単価順ソート | rate降順 |
| 応募済み除外 | 応募した案件を除外 |

#### GET /api/jobs/[id]（案件詳細）
| テストケース | 説明 |
|-------------|------|
| 正常系 | 案件詳細を返す |
| 存在しない案件 | 404エラー |
| クローズ案件 | 詳細は表示可能 |

### 4. 応募API

#### POST /api/applications（応募作成）
| テストケース | 説明 |
|-------------|------|
| 正常系 | 応募作成＋メール・Slack通知 |
| プロフィール未完了 | missingFields付きで成功 |
| 重複応募 | 409エラー |
| 存在しない案件 | 404エラー |
| 未認証 | 401エラー |

#### GET /api/applications/me（応募履歴）
| テストケース | 説明 |
|-------------|------|
| 正常系 | 応募履歴一覧取得 |
| 未認証 | 401エラー |

#### PATCH /api/applications/[id]（応募取消し）
| テストケース | 説明 |
|-------------|------|
| 正常系 | ステータス変更＋メール送信 |
| 取消し不可 | 400エラー（面談中など） |
| 存在しない応募 | 404エラー |
| ステータス未指定 | 400エラー |
| 未認証 | 401エラー |

### 5. 管理者API

#### POST /api/admin/login（管理者ログイン）
| テストケース | 説明 |
|-------------|------|
| 正常系 | ログイン成功 |
| 認証失敗 | 401エラー |
| 空メール | 400エラー |
| 空パスワード | 400エラー |

#### GET/POST /api/admin/batch-settings（バッチ設定）
| テストケース | 説明 |
|-------------|------|
| GET 正常系 | 設定取得 |
| GET 未認証 | 401エラー |
| POST 正常系 | 設定更新 |
| POST 閾値範囲外（負） | 400エラー |
| POST 閾値範囲外（上限） | 400エラー |
| POST maxPerJob範囲外 | 400エラー |
| POST 未認証 | 401エラー |

---

## E2Eテスト詳細

### 認証フロー（auth.spec.ts）

```
1.1 ログインページ
  - ログインページが表示される
  - メールアドレスとパスワードが入力できる
  - 空のフォームで送信するとエラーが表示される

1.2 新規登録ページ
  - 新規登録ページが表示される
  - ログインページへのリンクがある

1.3 パスワードリセットページ
  - パスワードリセットページが表示される

1.4 未認証時のリダイレクト
  - ダッシュボードにアクセスするとログインページにリダイレクト
  - マイページにアクセスするとログインページにリダイレクト
```

### プロフィール・応募履歴（profile.spec.ts）

```
2.1 プロフィール表示
  - 未認証時はプロフィールページにアクセスできない
  - マイページ（設定）にアクセスするとリダイレクトされる

4.1 応募履歴表示
  - 未認証時は応募履歴ページにアクセスできない

6.1 お問い合わせフォーム
  - お問い合わせページが表示される

7.1 退会フロー
  - 未認証時は退会ページにアクセスできない
```

### 通知・案件UI（notifications.spec.ts）

```
9.1 通知ドロップダウン
  - ヘッダーに通知アイコンが表示される

9.2 お知らせバナー
  - トップページにアナウンスメントバナーが表示される

9.3 ページ遷移
  - 通知一覧ページが存在する場合、アクセスできる

3.1 案件一覧ページ
  - 案件一覧ページが表示される
  - 検索ボックスが表示される
  - フィルターUIが表示される
  - ソートUIが表示される

3.2 案件詳細モーダル
  - 案件カードをクリックすると詳細が表示される
```

### 管理者画面（admin.spec.ts）

```
8.1 管理者ログインページ
  - 管理者ログインページが表示される
  - 空のフォームで送信するとエラーが表示される

8.2 管理者ダッシュボード
  - 未認証時は管理者ダッシュボードにアクセスできない
  - バッチ設定ページは未認証時アクセス不可
```

### E2E実行方法

```bash
# 開発サーバーを起動してから実行
npm run dev &
npm run test:e2e

# UIモードで実行（デバッグ用）
npm run test:e2e:ui
```

---

## モック設計

### 認証モック

```typescript
// tests/helpers/auth.ts
// vi.mockを使用して認証状態をシミュレート
vi.mock("@/lib/auth-server", () => ({
  getSession: vi.fn(() => mockSession),
}))

// テストでの使用例
beforeEach(() => {
  vi.mocked(getSession).mockResolvedValue(mockSession)  // 認証済み状態
})

it('未認証の場合は401', async () => {
  vi.mocked(getSession).mockResolvedValueOnce(null)  // 未認証状態に切り替え
  const response = await GET(request)
  expect(response.status).toBe(401)
})
```

### Kintoneモック

```typescript
// tests/mocks/kintone.ts
// Kintoneサービスをモック
vi.mock("@/lib/kintone/services/job", () => ({
  getAllJobs: vi.fn(() => mockJobs),
  getJobById: vi.fn(),
}))

vi.mock("@/lib/kintone/services/application", () => ({
  createApplication: vi.fn(() => "new-app-id"),
  checkDuplicateApplication: vi.fn(() => false),
  getApplicationsByAuthUserId: vi.fn(() => mockApplications),
}))
```

### テストフィクスチャ

```typescript
// tests/fixtures/users.ts
export const mockSession = {
  user: {
    id: "test-user-id",
    email: "test@example.com",
  },
}

// tests/fixtures/jobs.ts
export const mockJob = {
  id: "1",
  title: "React開発案件",
  features: ["フルリモート可"],
  skills: ["React", "TypeScript"],
  rate: "800000",
  recruitmentStatus: "募集中",
}
```

---

## CI/CD

### GitHub Actionsワークフロー

#### 1. テストワークフロー（.github/workflows/test.yml）

```yaml
トリガー: push/PR to develop, main

ジョブ:
1. lint
   - ESLint実行
   - TypeScriptチェック

2. unit-test（lintの後）
   - Jestテスト実行
   - カバレッジレポート生成
   - カバレッジをartifactとして保存

3. test-summary
   - 結果サマリー出力
```

#### 2. デプロイワークフロー（.github/workflows/deploy-apprunner.yml）

```yaml
トリガー: push to develop, main

ジョブ:
1. test
   - ESLint実行
   - TypeScriptチェック
   - Jestテスト実行
   ※テスト失敗時はデプロイをスキップ

2. deploy（testの後）
   - Dockerイメージビルド
   - ECRにプッシュ
   - App Runnerにデプロイ
```

### 環境変数（CI用）

```yaml
# テスト実行に必要な環境変数（.github/workflows/test.yml）
KINTONE_BASE_URL: 'https://example.cybozu.com'
KINTONE_TALENT_API_TOKEN: 'test-token'
KINTONE_TALENT_APP_ID: '1'
KINTONE_JOB_API_TOKEN: 'test-token'
KINTONE_JOB_APP_ID: '2'
KINTONE_APPLICATION_API_TOKEN: 'test-token'
KINTONE_APPLICATION_APP_ID: '3'
KINTONE_RECOMMENDATION_API_TOKEN: 'test-token'
KINTONE_RECOMMENDATION_APP_ID: '4'
NEXT_PUBLIC_APP_URL: 'http://localhost:3000'
BETTER_AUTH_SECRET: 'test-secret-key-for-ci-must-be-32-chars-minimum'
```

---

## ユニットテスト詳細

### Lambdaマッチングロジック（matching.test.ts）

AIマッチングスコア計算のコアロジックをテストしています。

#### 10.1 スコア計算

| テストケース | 説明 |
|-------------|------|
| スキルマッチ計算 | 人材スキルと案件スキルの一致でスコア加算 |
| スキル出現回数カウント | 複数箇所で出現するスキルはカウントされる |
| 職種マッチ計算 | 人材職種と案件職種の一致でスコア加算 |
| スコアゼロのケース | マッチなしの場合はスコア0 |
| 経験からのスコア加算 | 職務経歴からのキーワードマッチ |
| 複数ソースからの加算 | スキル＋経験の両方からマッチ時の合算 |
| 返り値の構造検証 | MatchResult構造体の正しいフォーマット |

#### 10.2 閾値判定

| テストケース | 説明 |
|-------------|------|
| 閾値未満の判定 | 低スコアは閾値未満と判定 |
| 閾値以上の判定 | 高スコアは閾値以上と判定 |

#### 10.3 エッジケース

| テストケース | 説明 |
|-------------|------|
| 空スキル | エラーにならずスコア0を返す |
| nullish値 | エラーにならずに処理される |

---

## トラブルシューティング

### テストが「Cannot find module」エラーで失敗する

```bash
npm install
rm -rf node_modules/.vitest
npm test
```

### モックが効いていない

```typescript
// vi.mockはファイルの先頭（importより前）に配置
vi.mock('@/lib/auth-server', () => ({
  getSession: vi.fn(() => mockSession),
}))

// beforeEachでモックをリセット
beforeEach(() => {
  vi.clearAllMocks()
})
```

### E2Eテストがタイムアウトする

```bash
# 開発サーバーが起動しているか確認
npm run dev

# タイムアウトを延長
npx playwright test --timeout=60000

# 特定のテストのみ実行
npx playwright test tests/e2e/auth.spec.ts
```

### E2Eテストがサーバー未起動でエラーになる

```bash
# サーバーを起動してからテスト実行
npm run dev &
sleep 10
npm run test:e2e
```

---

## ベストプラクティス

### 1. テストは独立させる

```typescript
beforeEach(() => {
  vi.clearAllMocks()
  vi.mocked(getSession).mockResolvedValue(mockSession)
})
```

### 2. わかりやすいテスト名を使う

```typescript
// 良い例
it('未認証の場合は401エラーを返す', async () => {})
it('重複応募の場合は409エラーを返す', async () => {})
```

### 3. describeでテストケースIDを管理

```typescript
// 良い例 - ドキュメントのIDと対応
describe("4.1.1 案件への応募", () => {
  it("ログインユーザーが案件に応募できる", async () => {})
})
```

### 4. エラーケースも必ずテストする

```typescript
it('Kintoneエラー時は500を返す', async () => {
  vi.mocked(getAllJobs).mockRejectedValue(new Error('Kintone API Error'))
  const response = await GET(request)
  expect(response.status).toBe(500)
})
```

### 5. 非同期処理はawaitで待つ

```typescript
it('メール送信が完了する', async () => {
  await POST(request)

  // 非同期処理の完了を待つ
  await new Promise((resolve) => setTimeout(resolve, 10))

  expect(sendEmail).toHaveBeenCalled()
})
```

---

## 関連ドキュメント

- [Vitest公式ドキュメント](https://vitest.dev/)
- [Playwright公式ドキュメント](https://playwright.dev/)
- [Testing Library](https://testing-library.com/)
