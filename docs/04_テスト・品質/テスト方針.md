# テスト戦略とCI/CD

## 概要

このプロジェクトでは、3層のテスト戦略を採用しています。

| レイヤー | ツール | 対象 | テスト数 |
|---------|--------|------|----------|
| APIテスト | Vitest | API Routes（認証、応募、案件、プロフィール、管理者） | 75件 |
| ユニットテスト | Vitest | Lambdaマッチングロジック | 11件 |
| E2Eテスト | Playwright | ユーザーフロー（ログイン、応募、管理者画面） | 25件 |

**合計: 111テスト**

---

## 機能テストケース仕様

このセクションは、アプリケーションの基本的な操作と、その操作に対して何が起こるのかを網羅的にまとめたものです。

### テストケース概要

| No | カテゴリ | 項目数 |
|----|----------|--------|
| [1. ユーザー登録・認証](#1-ユーザー登録認証) | 新規登録、ログイン、パスワードリセット、メール変更、ログアウト | 17 |
| [2. プロフィール管理](#2-プロフィール人材情報管理) | プロフィール取得・更新、郵便番号住所取得、ファイル操作 | 10 |
| [3. 案件管理](#3-案件管理) | 案件一覧、検索・フィルター、ソート、詳細 | 11 |
| [4. 応募管理](#4-応募管理) | 応募、履歴確認、取消し | 10 |
| [5. 推薦・マッチング](#5-推薦マッチング) | おすすめ案件、マッチングスコア | 3 |
| [6. お問い合わせ](#6-お問い合わせ) | フォーム送信 | 1 |
| [7. 退会](#7-退会) | 退会手続き、退会後の動作 | 2 |
| [8. 管理者機能](#8-管理者機能) | 認証、AIマッチング、担当者おすすめ、バッチ設定 | 8 |
| [9. アプリ内通知・バッジ](#9-アプリ内通知バッジ) | バナー、ドロップダウン、各種通知、既読処理 | 26 |
| [10. Lambdaバッチ処理](#10-lambdaバッチ処理) | スコアマッチ、閾値変更、インクリメンタル計算、面談リマインド | 30 |
| [11. Webhook](#11-webhook外部連携) | 案件作成時の処理 | 1 |
| [12. Slack通知一覧](#12-slack通知一覧まとめ) | 全Slack通知のまとめ | 4 |
| [13. メール送信一覧](#13-メール送信一覧まとめ) | 全メール送信のまとめ | 10 |
| **合計** | | **約133項目** |

---

### 1. ユーザー登録・認証

#### 1.1 新規ユーザー登録

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 1.1.1 | メールアドレス、パスワード、姓名、電話番号、生年月日を入力して登録ボタンを押す | - userテーブルにレコードが作成される<br>- 入力したメールアドレスに確認メールが送信される<br>- サインアップ情報がクッキーに保存される（1時間） |
| 1.1.2 | 確認メール内のリンクをクリックする | - メールアドレスが確認済みになる<br>- Kintone人材DBに新規レコードが作成される<br>- **Slack通知が送信される（新規登録通知）**<br>- プロフィール入力ページにリダイレクトされる |
| 1.1.3 | 既に登録済みのメールアドレスで登録しようとする | - エラーメッセージが表示される<br>- レコードは作成されない |
| 1.1.4 | 無効なメールアドレス形式で登録しようとする | - バリデーションエラーが表示される |
| 1.1.5 | パスワードが6文字未満で登録しようとする | - バリデーションエラーが表示される |

#### 1.2 ログイン

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 1.2.1 | 正しいメールアドレスとパスワードでログインする | - セッションが作成される<br>- ダッシュボードにリダイレクトされる |
| 1.2.2 | 間違ったパスワードでログインする | - エラーメッセージが表示される<br>- ログインできない |
| 1.2.3 | 存在しないメールアドレスでログインする | - エラーメッセージが表示される<br>- ログインできない |
| 1.2.4 | 退会済みユーザーでログインしようとする | - ログインがブロックされる<br>- 退会済みである旨のエラーが表示される |
| 1.2.5 | メール未確認のユーザーでログインしようとする | - ログインできない<br>- メール確認を促すメッセージが表示される |

#### 1.3 パスワード変更・リセット

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 1.3.1 | パスワード変更（ログイン後）：現在のパスワードと新しいパスワードを入力して変更する | - パスワードが更新される<br>- パスワード変更完了通知メールが送信される<br>- ログアウトされ、ログインページにリダイレクトされる |
| 1.3.2 | パスワードリセット申請（パスワードを忘れた場合）：メールアドレスを入力してリセットを申請する | - リセットリンク付きのメールが送信される<br>- リンクは1時間有効 |
| 1.3.3 | リセットリンクをクリックして新しいパスワードを設定する | - パスワードが更新される<br>- ログインページにリダイレクトされる |
| 1.3.4 | 期限切れのリセットリンクをクリックする | - エラーメッセージが表示される<br>- パスワードは変更されない |

#### 1.4 メールアドレス変更

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 1.4.1 | 設定画面で「メールアドレスを変更する」ボタンをクリックし、ダイアログで現在のパスワードと新しいメールアドレスを入力して変更申請する | - 現在のパスワードで認証される<br>- 新しいメールアドレスに確認メールが送信される<br>- 確認メール送信完了のメッセージが表示される |
| 1.4.2 | 確認リンクをクリックする | - メールアドレスが新しいものに更新される<br>- 変更完了のメッセージが表示される<br>- ログアウトされ、ログインページにリダイレクトされる（新しいメールアドレスでの再ログインを促す） |
| 1.4.3 | 現在のパスワードが間違っている場合 | - エラーメッセージが表示される<br>- メールは送信されない |
| 1.4.4 | 現在のメールアドレスと同じメールアドレスを入力した場合 | - エラーメッセージが表示される<br>- メールは送信されない |

#### 1.5 ログアウト

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 1.5.1 | ログアウトボタンを押す | - セッションが削除される<br>- ログインページにリダイレクトされる |

---

### 2. プロフィール（人材情報）管理

#### 2.1 プロフィール取得

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 2.1.1 | マイページを開く | - Kintone人材DBから自分のプロフィール情報が取得される<br>- 登録済みの情報が表示される |
| 2.1.2 | 退会済みユーザーがマイページを開こうとする | - エラーが返される（withdrawn: true） |

#### 2.2 プロフィール更新

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 2.2.1 | 基本情報（氏名、電話番号等）を更新する | - Kintone人材DBのレコードが更新される |
| 2.2.2 | スキル情報（言語・ツール）を更新する | - Kintone人材DBのレコードが更新される |
| 2.2.3 | 希望条件（単価、稼働時期等）を更新する | - Kintone人材DBのレコードが更新される |
| 2.2.4 | 職務経歴書をアップロードする | - ファイルがアップロードされる<br>- Kintone人材DBに添付される |
| 2.2.5 | 必須項目をすべて入力してプロフィールを完成させる（初めて） | - プロフィールが更新される<br>- **Slack通知が送信される（プロフィール完成通知）** |
| 2.2.6 | すでにプロフィール完成済みの状態で更新する | - プロフィールが更新される<br>- Slack通知は送信されない（初回のみ） |

#### 2.3 郵便番号からの住所自動取得

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 2.3.1 | プロフィール編集画面で郵便番号を入力する | - 住所（都道府県・市区町村・町域）が自動入力される |

#### 2.4 ファイル操作

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 2.4.1 | 職務経歴書ファイルをアップロードする | - ファイルがアップロードされる<br>- ファイルURLがプロフィールに保存される |
| 2.4.2 | 職務経歴書ファイルを削除する | - ファイルが削除される<br>- プロフィールからファイル情報が削除される |

---

### 3. 案件管理

#### 3.1 案件一覧取得

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 3.1.1 | 案件一覧ページを開く | - 募集中の案件一覧が表示される<br>- クローズ済み案件は表示されない |
| 3.1.2 | 応募済みの案件一覧を開く | - 自分が応募した案件のみが表示される |

#### 3.2 案件検索・フィルター

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 3.2.1 | キーワードで検索する | - 案件名、概要、スキル等にキーワードを含む案件が表示される<br>- 複数キーワードはAND検索 |
| 3.2.2 | リモート可否でフィルターする | - 選択した条件（フルリモート/リモート併用/常駐）に一致する案件が表示される |
| 3.2.3 | 職種でフィルターする | - 選択した職種の案件のみが表示される |
| 3.2.4 | 勤務地エリアでフィルターする | - 選択したエリアの案件のみが表示される |
| 3.2.5 | 最寄駅でフィルターする | - 選択した最寄駅の案件のみが表示される |

#### 3.3 案件ソート

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 3.3.1 | おすすめ順でソートする | - 担当者おすすめ → AIマッチ → 適合スコア順で表示される |
| 3.3.2 | 新着順でソートする | - 作成日時が新しい順に表示される |
| 3.3.3 | 単価順（高い順）でソートする | - 掲載単価が高い順に表示される |

#### 3.4 案件詳細

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 3.4.1 | 案件詳細ページを開く | - 案件の詳細情報が表示される |
| 3.4.2 | 応募済みの案件詳細を開く | - 案件詳細が表示される<br>- 応募済みである旨が表示される |

---

### 4. 応募管理

#### 4.1 案件応募

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 4.1.1 | 案件に応募する | - Kintone応募履歴DBにレコードが作成される<br>- 対応状況が「応募済み」に設定される<br>- **応募完了メールが送信される**<br>- **Slack通知が送信される（応募通知）** |
| 4.1.2 | プロフィール必須項目が未入力の状態で応募しようとする | - プロフィール入力を促すメッセージが表示される<br>- 応募自体は可能 |
| 4.1.3 | 応募後に案件一覧を開く | - 応募した案件は通常の案件一覧から非表示になる |
| 4.1.4 | 応募完了モーダルで「マイページで入力する」を押す | - モーダルが閉じる<br>- 未入力項目に応じた適切なマイページタブに遷移する（プロフィール/職歴・資格/希望条件）<br>- 複数タブにまたがる場合は優先度の高いタブに遷移する |
| 4.1.5 | 応募完了モーダルで「応募済み案件を確認する」を押す | - モーダルが閉じる<br>- ページがリロードされる<br>- 応募済み案件一覧に遷移する<br>- 応募した案件が表示される |
| 4.1.6 | 応募後に応募済み案件一覧を開く | - 応募した案件が応募済み一覧に表示される |

#### 4.2 応募履歴確認

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 4.2.1 | 応募履歴ページを開く | - 自分の応募履歴が表示される（3ヶ月以内）<br>- 開発環境（APP_ID: 84）では`作成日時_開発環境`フィールドで判定<br>- 本番環境（APP_ID: 8）では`作成日時`フィールドで判定 |
| 4.2.2 | 応募の詳細を確認する | - 応募日時、案件情報、対応状況が表示される |

#### 4.3 応募取消し

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 4.3.1 | 応募を取消しする | - 対応状況が「応募取消し」に更新される<br>- **応募取消しメールが送信される** |

---

### 5. 推薦・マッチング

#### 5.1 おすすめ案件

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 5.1.1 | おすすめ案件を確認する | - 担当者おすすめ案件が表示される<br>- AIマッチ案件が表示される<br>- 適合スコアが高い案件が表示される |
| 5.1.2 | 新着おすすめ通知を確認する | - 7日以内の新着おすすめ案件が表示される |

#### 5.2 マッチングスコア

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 5.2.1 | 案件一覧でスコアを確認する | - 自分の適合スコアが表示される<br>- 担当者おすすめ・AIマッチのバッジが表示される |

---

### 6. お問い合わせ

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 6.1 | お問い合わせフォームを送信する | - Kintone問い合わせDBにレコードが作成される<br>- お問い合わせ確認メールが送信される |

---

### 7. 退会

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 7.1 | 退会手続きを行う（退会理由を入力して確定） | - Kintone問い合わせDBに「退会申請」レコードが作成される<br>- Kintone人材DBのSTフィールドが「退会」に更新される<br>- **退会完了メールが送信される**<br>- ログアウトされる |
| 7.2 | 退会後にログインしようとする | - ログインがブロックされる |

---

### 8. 管理者機能

#### 8.1 管理者認証

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 8.1.1 | 管理者としてログインする | - 管理者セッションが作成される<br>- 管理画面にアクセスできる |
| 8.1.2 | 管理者としてログアウトする | - 管理者セッションが削除される |

#### 8.2 AIマッチング

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 8.2.1 | AIマッチングを実行する | - 選定した人材に対してGemini AIで評価が実行される<br>- 評価結果がKintone推薦DBに保存される<br>- **AIマッチ通知メールが送信される** |
| 8.2.2 | マッチング結果を確認する | - AIマッチングの結果一覧が表示される |

#### 8.3 担当者おすすめ

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 8.3.1 | 担当者おすすめを設定する | - Kintone推薦DBのおすすめフラグが「おすすめ」に更新される<br>- **担当者おすすめ通知メールが送信される** |
| 8.3.2 | 担当者おすすめを解除する | - Kintone推薦DBのおすすめフラグが空白に更新される |

#### 8.4 バッチ設定

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 8.4.1 | スコア閾値を変更する | - appSettingsテーブルの設定が更新される<br>- マッチング抽出の閾値が変更される |
| 8.4.2 | 最大件数を変更する | - appSettingsテーブルの設定が更新される<br>- マッチング抽出の最大件数が変更される |

---

### 9. アプリ内通知・バッジ

#### 9.1 アナウンスメントバナー（帯状通知）

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 9.1.1 | 掲載期間内のお知らせがある状態でページを開く | - ページ上部に帯状のバナーが表示される<br>- 形式: 【掲載開始日】通知内容 |
| 9.1.2 | 複数のお知らせがある場合 | - 1件ずつ順番に表示される<br>- 「n件中m件目」の表示がある |
| 9.1.3 | バナーの×ボタンをクリックする | - バナーがフェードアウトして閉じる<br>- ローカルストレージに閉じたIDが保存される<br>- 次のお知らせがあれば表示される |
| 9.1.4 | 閉じたお知らせがある状態で再度ページを開く | - 閉じたお知らせは表示されない |
| 9.1.5 | 掲載期間外のお知らせのみの場合 | - バナーは表示されない |

#### 9.2 通知ドロップダウン（ベルアイコン）

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 9.2.1 | 未読通知がある状態でヘッダーを確認する | - ベルアイコンに赤い通知バッジが表示される<br>- バッジに未読件数が表示される（99件以上は「99+」） |
| 9.2.2 | ベルアイコンをクリックする | - 通知ドロップダウンが開く<br>- 通知一覧が表示される |
| 9.2.3 | 通知がない状態でベルアイコンを確認する | - 通知バッジは表示されない |
| 9.2.4 | 通知をクリックする | - 該当のページ/モーダルに遷移する<br>- 通知が既読になる（一覧から消える） |
| 9.2.5 | 別のユーザーでログインする | - 前のユーザーの通知はクリアされる<br>- 新しいユーザーの通知が読み込まれる |

#### 9.3 おすすめ案件通知（プログラムマッチ）

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 9.3.1 | 推薦レコードが作成されてから7日以内にログインする | - 通知ドロップダウンに新着おすすめ案件が表示される |
| 9.3.2 | おすすめ案件の通知をクリックする | - 案件詳細モーダルが開く<br>- 通知が既読になる |
| 9.3.3 | 推薦レコード作成から8日以上経過後にログインする | - その推薦は通知に表示されない（7日以内のみ） |

#### 9.4 担当者おすすめ通知

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 9.4.1 | 担当者おすすめが設定された後にログインする | - 通知ドロップダウンに「担当者からあなたに向けた案件オファーが届いています」が表示される |
| 9.4.2 | 担当者おすすめ通知の【オファーを確認する】をクリックする | - 案件詳細モーダルが開く<br>- 通知が既読になる |
| 9.4.3 | 担当者おすすめが解除された場合 | - 該当の通知は表示されなくなる |

#### 9.5 プロフィール未入力警告

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 9.5.1 | 必須項目が未入力の状態でログインする | - 通知ドロップダウンに「マイページの必須項目が未記入です」が表示される<br>- 未入力のタブ（プロフィール/職歴・資格/希望条件）が案内される |
| 9.5.2 | プロフィール未入力通知をクリックする | - 該当のマイページタブに遷移する |
| 9.5.3 | 通知を閉じて24時間以内に再度ログインする | - プロフィール未入力通知は表示されない |
| 9.5.4 | 通知を閉じて24時間以上経過後に再度ログインする | - プロフィール未入力通知が再度表示される |
| 9.5.5 | 必須項目をすべて入力した後にログインする | - プロフィール未入力通知は表示されない |

#### 9.6 面談予定確定通知

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 9.6.1 | 応募の対応状況が「面談予定」に変更された後にアプリを開く | - 通知ドロップダウンに「面談予定が確定しました」が表示される<br>- **面談予定確定メールが送信される** |
| 9.6.2 | 面談予定確定通知の【応募済み案件】をクリックする | - 応募済み案件ページに遷移する<br>- 該当の案件が表示される |
| 9.6.3 | 同じ案件で再度「面談予定」に変更された場合 | - 重複してメールは送信されない（送信済みIDで管理） |

#### 9.7 通知の既読・クリア

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 9.7.1 | 通知をクリックして確認する | - その通知が既読になる<br>- ローカルストレージの既読セットに追加される<br>- 通知バッジの件数が減る |
| 9.7.2 | すべての通知を確認する | - 通知バッジが非表示になる |

---

### 10. Lambdaバッチ処理

#### 10.1 スコアマッチバッチ処理（基本動作）

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 10.1.1 | バッチ処理が毎日JST 02:00に実行される | - Step Functionsが起動される<br>- GetJobs → ProcessJob(並列) → UpdateState の順で実行される |
| 10.1.2 | アクティブな案件と人材の組み合わせでスコアが計算される | - 案件の「職種_ポジション」「スキル」からキーワード抽出<br>- 人材の「職種」「言語_ツール」「主な実績_PR_職務経歴」で出現回数をカウント<br>- 合計出現回数がスコアとして記録される |
| 10.1.3 | スコアが閾値以上の場合 | - Kintone推薦DBに推薦レコードが作成される |
| 10.1.4 | スコアが閾値未満の場合 | - 推薦レコードは作成されない<br>- 既存の推薦レコードがあれば削除される |
| 10.1.5 | 退会済みの人材がいる場合 | - 該当人材の推薦レコードは削除される |
| 10.1.6 | 非アクティブ（クローズ）の案件がある場合 | - 該当案件の推薦レコードは処理対象外 |

#### 10.2 閾値変更時の動作

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 10.2.1 | 閾値を上げる（例: 3 → 5） | - 「閾値上昇削除のみ」モードで実行される<br>- 新たなスコア計算は実行されない（高速処理）<br>- スコア < 新閾値のレコードが削除される |
| 10.2.2 | 閾値を上げた場合、AIマッチ実行済みのレコード | - 保護対象として削除されない |
| 10.2.3 | 閾値を上げた場合、担当者おすすめのレコード | - 保護対象として削除されない |
| 10.2.4 | 閾値を下げる（例: 5 → 3） | - 「フル計算」モードで実行される<br>- 全案件・全人材の組み合わせを再計算<br>- 新しい閾値以上のマッチが推薦レコードとして作成される |
| 10.2.5 | 閾値を下げた場合、以前削除されていたペア | - 新閾値以上のスコアであれば推薦レコードが復活（新規作成） |

#### 10.3 インクリメンタル計算

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 10.3.1 | 前回バッチ以降に人材情報が更新された場合 | - 該当人材に関連するスコアが再計算される |
| 10.3.2 | 前回バッチ以降に案件情報が更新された場合 | - 該当案件に関連するスコアが再計算される |
| 10.3.3 | 前回バッチ以降に更新がない人材・案件の組み合わせ | - 既存スコアが閾値以上であればスキップ（計算省略）<br>- 既存スコアがそのまま保持される |
| 10.3.4 | 初回実行または前回バッチ日時が不明な場合 | - 「フル計算」モードで全組み合わせを計算 |

#### 10.4 推薦レコードの作成・更新・削除

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 10.4.1 | 新規のマッチング（既存レコードなし、スコア≧閾値） | - Kintone推薦DBに新規レコードが作成される |
| 10.4.2 | 既存レコードのスコアが変更された場合 | - 推薦レコードの適合スコアが更新される |
| 10.4.3 | 既存レコードのスコアが閾値未満になった場合 | - 推薦レコードが削除される（保護対象除く） |
| 10.4.4 | AIマッチ実行済みのレコードが閾値未満になった場合 | - 保護対象として削除されない |
| 10.4.5 | 担当者おすすめのレコードが閾値未満になった場合 | - 保護対象として削除されない |
| 10.4.6 | 1案件あたりの推薦数がmaxPerJobを超える場合 | - スコア上位のmaxPerJob件のみが保持される |

#### 10.5 バッチ状態の更新

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 10.5.1 | バッチ処理が正常終了した場合 | - app_settingsテーブルのlastBatchTimeが更新される<br>- lastThresholdが実行時の閾値で更新される |
| 10.5.2 | 次回バッチ実行時 | - lastBatchTimeを参照してインクリメンタル計算が行われる<br>- lastThresholdと現在の閾値を比較して実行モードが決定される |

#### 10.6 面談リマインドバッチ処理

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 10.6.1 | バッチ処理が毎日JST 10:00に実行される | - Lambda関数が起動される |
| 10.6.2 | 翌日に面談予定がある場合 | - 該当する人材と案件情報を取得<br>- **Slack通知が送信される（面談リマインド）** |
| 10.6.3 | 翌日に面談予定がない場合 | - Slack通知は送信されない |

#### 10.7 手動実行（refresh-recommendations.ts）

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 10.7.1 | `npx tsx scripts/refresh-recommendations.ts` を実行 | - Lambdaと同じロジックでスコア計算が実行される |
| 10.7.2 | `--threshold 5` オプションで実行 | - 指定した閾値（5）でスコア計算が実行される |
| 10.7.3 | `--full` オプションで実行 | - インクリメンタル計算をスキップしてフル計算が実行される |
| 10.7.4 | `--dry-run` オプションで実行 | - 実際の変更は行わず、処理結果のプレビューのみ表示される |

---

### 11. Webhook（外部連携）

| No | 操作 | 期待される結果 |
|----|------|----------------|
| 11.1 | 案件が作成されたとき（Kintone Webhook） | - 新規案件のマッチング処理が実行される |

---

### 12. Slack通知一覧（まとめ）

| No | トリガー | 通知内容 |
|----|----------|----------|
| 12.1 | 新規ユーザー登録（メール確認完了時） | 姓名、メール、電話、登録日時、人材DBリンク |
| 12.2 | プロフィール完成（初回のみ） | 姓名、メール、人材DBリンク |
| 12.3 | 案件応募 | ユーザー氏名、案件タイトル、人材DB・案件DBリンク |
| 12.4 | 面談リマインド（日次バッチ） | 翌日の面談予定一覧 |

---

### 13. メール送信一覧（まとめ）

| No | トリガー | メール内容 |
|----|----------|------------|
| 13.1 | 新規登録時 | メールアドレス確認リンク |
| 13.2 | パスワードリセット申請時 | パスワードリセットリンク |
| 13.3 | メールアドレス変更申請時 | 変更確認リンク |
| 13.4 | 案件応募時 | 応募完了通知 |
| 13.5 | 応募取消し時 | 応募取消し通知 |
| 13.6 | 退会時 | 退会完了通知 |
| 13.7 | お問い合わせ時 | お問い合わせ確認 |
| 13.8 | AIマッチ実行時 | AIマッチ通知 |
| 13.9 | 担当者おすすめ設定時 | 担当者おすすめ通知 |
| 13.10 | 面談予定確定時 | 面談予定確定通知 |

---

### 補足: 環境別動作

#### 開発環境（ローカル）
- **メール送信**: コンソール出力
- **Slack通知**: コンソール出力（`📢 [Slack通知 - 開発環境]`）
- **キャッシュ**: メモリ内キャッシュ（5分）

#### 本番環境
- **メール送信**: Amazon SES
- **Slack通知**: Slack Incoming Webhook
- **キャッシュ**: Redis + メモリキャッシュ

---

### テスト実施時の注意事項

1. **テストデータの準備**: `npm run seed` でテストデータを生成可能
2. **キャッシュクリア**: `/api/dev/clear-cache` でキャッシュをクリア可能
3. **Kintone連携**: テスト環境用のKintoneアプリを使用すること
4. **退会テスト後の復帰**: STフィールドを手動で空にする必要あり

---

## テストファイル構成

```
proworks-app/
├── tests/
│   ├── api/                          # APIテスト
│   │   ├── auth/
│   │   │   ├── signup.test.ts        # POST /api/auth/signup-with-email
│   │   │   ├── password-change.test.ts # POST /api/auth/change-password
│   │   │   ├── password-reset.test.ts # POST /api/auth/forgot-password
│   │   │   └── email-change.test.ts  # POST /api/auth/change-email
│   │   ├── me/
│   │   │   └── profile.test.ts       # GET/PATCH /api/me
│   │   ├── jobs/
│   │   │   └── jobs.test.ts          # GET /api/jobs, GET /api/jobs/[id]
│   │   ├── applications/
│   │   │   └── applications.test.ts  # POST/GET/PATCH /api/applications
│   │   └── admin/
│   │       └── admin.test.ts         # POST /api/admin/login, バッチ設定
│   ├── unit/
│   │   └── lambda/
│   │       └── matching.test.ts      # マッチングスコア計算
│   ├── e2e/                          # E2Eテスト
│   │   ├── auth.spec.ts              # 認証フロー
│   │   ├── profile.spec.ts           # プロフィール・応募履歴
│   │   ├── notifications.spec.ts     # 通知・案件一覧UI
│   │   └── admin.spec.ts             # 管理者画面
│   ├── mocks/                        # 共通モック
│   │   ├── kintone.ts
│   │   ├── ses.ts
│   │   └── slack.ts
│   ├── fixtures/                     # テストデータ
│   │   ├── users.ts
│   │   └── jobs.ts
│   └── helpers/                      # テストヘルパー
│       ├── auth.ts
│       └── api.ts
├── vitest.config.ts
└── playwright.config.ts
```

---

## テスト実行コマンド

### 基本コマンド（手法別）

```bash
# 全テスト実行
npm test

# ウォッチモード
npm run test:watch

# APIテストのみ
npm run test:api

# ユニットテストのみ
npm run test:unit

# E2Eテスト実行（ヘッドレス）
npm run test:e2e

# E2Eテスト（UIモード）
npm run test:e2e:ui

# カバレッジレポート生成
npm run test:coverage
```

### 機能別テストコマンド

機能ごとにテストを実行できます。コード変更時に関連テストだけ実行したい場合に便利です。

| コマンド | 対象機能 | 実行内容 |
|----------|----------|----------|
| `npm run test:auth` | 認証関連 | API + E2E |
| `npm run test:profile` | プロフィール | API + E2E |
| `npm run test:jobs` | 案件 | API |
| `npm run test:applications` | 応募 | API |
| `npm run test:admin` | 管理者 | API + E2E |
| `npm run test:lambda` | Lambdaバッチ処理 | Unit |
| `npm run test:notifications` | 通知UI | E2E |

```bash
# 例：認証周りのコードを変更した場合
npm run test:auth

# 例：案件APIを変更した場合
npm run test:jobs

# 例：Lambdaマッチングロジックを変更した場合
npm run test:lambda
```

---

## 機能別テストカバレッジ

以下の表は、各機能がAPIテストとE2Eテストでどのようにカバーされているかを示しています。

### 認証関連（`npm run test:auth`）

| ID | テスト項目 | API | E2E |
|----|-----------|-----|-----|
| 1.1.1 | 正常な登録（必須項目入力） | ✅ | - |
| 1.1.3 | 既存メールアドレスでのエラー | ✅ | - |
| 1.1.4 | 無効なメールアドレス | ✅ | - |
| 1.3.1 | パスワード変更（ログイン後） | ✅ | - |
| 1.3.2 | パスワードリセット申請（パスワードを忘れた場合） | ✅ | - |
| 1.4.1 | メールアドレス変更申請（パスワード認証+確認メール送信） | ✅ | - |
| 1.4.3 | パスワード不一致エラー | ✅ | - |
| 1.4.4 | 同一メールアドレスエラー | ✅ | - |
| - | ログインページ表示 | - | ✅ |
| - | 新規登録ページ表示 | - | ✅ |
| - | パスワードリセットページ表示 | - | ✅ |
| - | 未認証時のリダイレクト | - | ✅ |

**対象ファイル:**
- API: `tests/api/auth/signup.test.ts`, `password-change.test.ts`, `password-reset.test.ts`, `email-change.test.ts`
- E2E: `tests/e2e/auth.spec.ts`

### プロフィール関連（`npm run test:profile`）

| ID | テスト項目 | API | E2E |
|----|-----------|-----|-----|
| 2.1.1 | プロフィール取得 | ✅ | - |
| 2.1.2 | 退会済みユーザーのアクセス制御 | ✅ | - |
| 2.2.1 | 基本情報の更新 | ✅ | - |
| 2.2.2 | スキル情報の更新 | ✅ | - |
| 2.2.3 | 希望条件の更新 | ✅ | - |
| 2.2.5 | プロフィール完成時のSlack通知 | ✅ | - |
| - | 未認証時のプロフィールページアクセス拒否 | - | ✅ |
| - | 応募履歴ページへのアクセス制御 | - | ✅ |
| - | 退会ページへのアクセス制御 | - | ✅ |
| - | お問い合わせページ表示 | - | ✅ |

**対象ファイル:**
- API: `tests/api/me/profile.test.ts`
- E2E: `tests/e2e/profile.spec.ts`

### 案件関連（`npm run test:jobs`）

| ID | テスト項目 | API | E2E |
|----|-----------|-----|-----|
| 3.1.1 | 全案件取得（クローズ除外） | ✅ | - |
| 3.1.2 | ページネーション（skip/limit） | ✅ | - |
| 3.1.3 | キーワード検索（AND検索） | ✅ | - |
| 3.1.4 | 職種フィルター | ✅ | - |
| 3.1.5 | リモート可否フィルター | ✅ | - |
| 3.1.6 | 勤務地フィルター | ✅ | - |
| 3.1.7 | 並び替え（新着順・単価順） | ✅ | - |
| 3.2.1 | 案件詳細取得 | ✅ | - |
| 3.2.2 | 存在しない案件のエラー処理 | ✅ | - |
| 3.3.1 | 応募済み案件の除外 | ✅ | - |
| 3.3.2 | クローズ案件の詳細表示 | ✅ | - |

**対象ファイル:**
- API: `tests/api/jobs/jobs.test.ts`

### 応募関連（`npm run test:applications`）

| ID | テスト項目 | API | E2E |
|----|-----------|-----|-----|
| 4.1.1 | 案件への応募 | ✅ | - |
| 4.1.2 | 応募時のプロフィール未完了警告 | ✅ | - |
| 4.1.3 | 存在しない案件への応募エラー | ✅ | - |
| 4.2.1 | 応募履歴一覧取得 | ✅ | - |
| 4.3.1 | 応募取消し | ✅ | - |
| 4.3.2 | 取消し不可のケース（面談中） | ✅ | - |
| 4.3.3 | 存在しない応募のエラー処理 | ✅ | - |

**対象ファイル:**
- API: `tests/api/applications/applications.test.ts`

### 管理者関連（`npm run test:admin`）

| ID | テスト項目 | API | E2E |
|----|-----------|-----|-----|
| 8.1.1 | 管理者ログイン（正常系） | ✅ | - |
| 8.1.2 | 管理者ログインバリデーション | ✅ | - |
| 8.4.1 | バッチ設定取得 | ✅ | - |
| 8.4.2 | バッチ設定更新 | ✅ | - |
| - | 管理者ログインページ表示 | - | ✅ |
| - | 未認証時のダッシュボードアクセス拒否 | - | ✅ |
| - | 未認証時のバッチ設定ページアクセス拒否 | - | ✅ |

**対象ファイル:**
- API: `tests/api/admin/admin.test.ts`
- E2E: `tests/e2e/admin.spec.ts`

### Lambdaバッチ処理（`npm run test:lambda`）

| ID | テスト項目 | Unit |
|----|-----------|------|
| 10.1.1 | スキルマッチ計算 | ✅ |
| 10.1.2 | 職種マッチ計算 | ✅ |
| 10.1.3 | スコアゼロのケース | ✅ |
| 10.1.4 | 経験からのスコア加算 | ✅ |
| 10.1.5 | 複数ソースからのスコア加算 | ✅ |
| 10.1.6 | 返り値の構造検証 | ✅ |
| 10.2.1 | 閾値判定 | ✅ |
| 10.3 | 空データのハンドリング | ✅ |

**対象ファイル:**
- Unit: `tests/unit/lambda/matching.test.ts`

### 通知UI関連（`npm run test:notifications`）

| ID | テスト項目 | E2E |
|----|-----------|-----|
| 9.1 | 通知ドロップダウン表示 | ✅ |
| 9.2 | お知らせバナー表示 | ✅ |
| 9.3 | 通知一覧ページ遷移 | ✅ |
| 3.1 | 案件一覧ページ表示 | ✅ |
| 3.2 | 案件詳細モーダル表示 | ✅ |

**対象ファイル:**
- E2E: `tests/e2e/notifications.spec.ts`

---

## APIテスト詳細

### 認証API

#### POST /api/auth/signup-with-email（新規登録）
| テストケース | 説明 |
|-------------|------|
| 正常系：ユーザー登録 | 必須項目入力で登録成功 |
| 正常系：クッキー保存 | サインアップデータがクッキーに保存 |
| 正常系：rememberMe | ログイン保持クッキーが設定される |
| 異常系：既存メール | 400エラー（重複登録） |
| 異常系：空メール | 400エラー（バリデーション） |
| 異常系：予期しないエラー | 500エラー |

#### POST /api/auth/change-password（パスワード変更・ログイン後）
| テストケース | 説明 |
|-------------|------|
| 正常系：パスワード変更 | 現在のパスワードと新しいパスワードで変更成功 |
| 正常系：通知メール送信 | パスワード変更後に通知メールが送信される |
| 異常系：未認証 | 401エラー |
| 異常系：現在のパスワード未入力 | 400エラー |
| 異常系：新しいパスワード未入力 | 400エラー |
| 異常系：新しいパスワードが6文字未満 | 400エラー |
| 異常系：現在のパスワードが不正 | 400エラー |
| 異常系：パスワード変更処理失敗 | 500エラー |

#### POST /api/auth/forgot-password（パスワードリセット・パスワードを忘れた場合）
| テストケース | 説明 |
|-------------|------|
| 正常系：リセット申請 | メール送信成功 |
| セキュリティ：存在しないメール | 成功メッセージ（情報漏洩防止） |
| セキュリティ：内部エラー | 成功メッセージ（情報漏洩防止） |
| 異常系：空メール | 400エラー |

#### POST /api/auth/change-email（メールアドレス変更）
| テストケース | 説明 |
|-------------|------|
| 正常系：変更申請 | 確認メール送信 |
| 異常系：未認証 | 401エラー |
| 異常系：パスワード未入力 | 400エラー |
| 異常系：無効なメール形式 | 400エラー |
| 異常系：同一メール | 400エラー |
| 異常系：パスワード不一致 | 400エラー |

### プロフィールAPI（GET/PATCH /api/me）

| テストケース | 説明 |
|-------------|------|
| GET 正常系 | プロフィール情報を返す |
| GET 退会済み | 403エラー（アカウント無効） |
| GET 未認証 | 401エラー |
| GET レコードなし | 404エラー |
| PATCH 正常系 | プロフィール更新成功 |
| PATCH スキル更新 | スキル情報のみ更新 |
| PATCH 希望条件更新 | 希望条件のみ更新 |
| PATCH プロフィール完成通知 | Slack通知送信 |
| PATCH 未認証 | 401エラー |

### 案件API

#### GET /api/jobs（案件一覧）
| テストケース | 説明 |
|-------------|------|
| 全件取得 | クローズ案件除外で一覧取得 |
| 未認証取得 | 未認証でも取得可能 |
| ページネーション | skip/limit指定 |
| キーワード検索 | タイトル・スキル検索 |
| AND検索 | 複数キーワードAND条件 |
| 該当なし | 空配列を返す |
| 職種フィルター | ポジション絞り込み |
| リモートフィルター | リモート可否絞り込み |
| 勤務地フィルター | エリア絞り込み |
| 新着順ソート | 作成日時降順 |
| 単価順ソート | rate降順 |
| 応募済み除外 | 応募した案件を除外 |

#### GET /api/jobs/[id]（案件詳細）
| テストケース | 説明 |
|-------------|------|
| 正常系 | 案件詳細を返す |
| 存在しない案件 | 404エラー |
| クローズ案件 | 詳細は表示可能 |

### 応募API

#### POST /api/applications（応募作成）
| テストケース | 説明 |
|-------------|------|
| 正常系 | 応募作成＋メール・Slack通知 |
| プロフィール未完了 | missingFields付きで成功 |
| 存在しない案件 | 404エラー |
| 未認証 | 401エラー |

#### GET /api/applications/me（応募履歴）
| テストケース | 説明 |
|-------------|------|
| 正常系 | 応募履歴一覧取得 |
| 未認証 | 401エラー |

#### PATCH /api/applications/[id]（応募取消し）
| テストケース | 説明 |
|-------------|------|
| 正常系 | ステータス変更＋メール送信 |
| 取消し不可 | 400エラー（面談中など） |
| 存在しない応募 | 404エラー |
| ステータス未指定 | 400エラー |
| 未認証 | 401エラー |

### 管理者API

#### POST /api/admin/login（管理者ログイン）
| テストケース | 説明 |
|-------------|------|
| 正常系 | ログイン成功 |
| 認証失敗 | 401エラー |
| 空メール | 400エラー |
| 空パスワード | 400エラー |

#### GET/POST /api/admin/batch-settings（バッチ設定）
| テストケース | 説明 |
|-------------|------|
| GET 正常系 | 設定取得 |
| GET 未認証 | 401エラー |
| POST 正常系 | 設定更新 |
| POST 閾値範囲外（負） | 400エラー |
| POST 閾値範囲外（上限） | 400エラー |
| POST maxPerJob範囲外 | 400エラー |
| POST 未認証 | 401エラー |

---

## E2Eテスト詳細

### 認証フロー（auth.spec.ts）

```
1.1 ログインページ
  - ログインページが表示される
  - メールアドレスとパスワードが入力できる
  - 空のフォームで送信するとエラーが表示される

1.2 新規登録ページ
  - 新規登録ページが表示される
  - ログインページへのリンクがある

1.3 パスワードリセットページ
  - パスワードリセットページが表示される

1.4 未認証時のリダイレクト
  - ダッシュボードにアクセスするとログインページにリダイレクト
  - マイページにアクセスするとログインページにリダイレクト
```

### プロフィール・応募履歴（profile.spec.ts）

```
2.1 プロフィール表示
  - 未認証時はプロフィールページにアクセスできない
  - マイページ（設定）にアクセスするとリダイレクトされる

4.1 応募履歴表示
  - 未認証時は応募履歴ページにアクセスできない

6.1 お問い合わせフォーム
  - お問い合わせページが表示される

7.1 退会フロー
  - 未認証時は退会ページにアクセスできない
```

### 通知・案件UI（notifications.spec.ts）

```
9.1 通知ドロップダウン
  - ヘッダーに通知アイコンが表示される

9.2 お知らせバナー
  - トップページにアナウンスメントバナーが表示される

9.3 ページ遷移
  - 通知一覧ページが存在する場合、アクセスできる

3.1 案件一覧ページ
  - 案件一覧ページが表示される
  - 検索ボックスが表示される
  - フィルターUIが表示される
  - ソートUIが表示される

3.2 案件詳細モーダル
  - 案件カードをクリックすると詳細が表示される
```

### 管理者画面（admin.spec.ts）

```
8.1 管理者ログインページ
  - 管理者ログインページが表示される
  - 空のフォームで送信するとエラーが表示される

8.2 管理者ダッシュボード
  - 未認証時は管理者ダッシュボードにアクセスできない
  - バッチ設定ページは未認証時アクセス不可
```

### E2E実行方法

```bash
# 開発サーバーを起動してから実行
npm run dev &
npm run test:e2e

# UIモードで実行（デバッグ用）
npm run test:e2e:ui
```

---

## ユニットテスト詳細

### Lambdaマッチングロジック（matching.test.ts）

AIマッチングスコア計算のコアロジックをテストしています。

#### スコア計算

| テストケース | 説明 |
|-------------|------|
| スキルマッチ計算 | 人材スキルと案件スキルの一致でスコア加算 |
| スキル出現回数カウント | 複数箇所で出現するスキルはカウントされる |
| 職種マッチ計算 | 人材職種と案件職種の一致でスコア加算 |
| スコアゼロのケース | マッチなしの場合はスコア0 |
| 経験からのスコア加算 | 職務経歴からのキーワードマッチ |
| 複数ソースからの加算 | スキル＋経験の両方からマッチ時の合算 |
| 返り値の構造検証 | MatchResult構造体の正しいフォーマット |

#### 閾値判定

| テストケース | 説明 |
|-------------|------|
| 閾値未満の判定 | 低スコアは閾値未満と判定 |
| 閾値以上の判定 | 高スコアは閾値以上と判定 |

#### エッジケース

| テストケース | 説明 |
|-------------|------|
| 空スキル | エラーにならずスコア0を返す |
| nullish値 | エラーにならずに処理される |

---

## モック設計

### 認証モック

```typescript
// tests/helpers/auth.ts
// vi.mockを使用して認証状態をシミュレート
vi.mock("@/lib/auth-server", () => ({
  getSession: vi.fn(() => mockSession),
}))

// テストでの使用例
beforeEach(() => {
  vi.mocked(getSession).mockResolvedValue(mockSession)  // 認証済み状態
})

it('未認証の場合は401', async () => {
  vi.mocked(getSession).mockResolvedValueOnce(null)  // 未認証状態に切り替え
  const response = await GET(request)
  expect(response.status).toBe(401)
})
```

### Kintoneモック

```typescript
// tests/mocks/kintone.ts
// Kintoneサービスをモック
vi.mock("@/lib/kintone/services/job", () => ({
  getAllJobs: vi.fn(() => mockJobs),
  getJobById: vi.fn(),
}))

vi.mock("@/lib/kintone/services/application", () => ({
  createApplication: vi.fn(() => "new-app-id"),
  checkDuplicateApplication: vi.fn(() => false),
  getApplicationsByAuthUserId: vi.fn(() => mockApplications),
}))
```

### テストフィクスチャ

```typescript
// tests/fixtures/users.ts
export const mockSession = {
  user: {
    id: "test-user-id",
    email: "test@example.com",
  },
}

// tests/fixtures/jobs.ts
export const mockJob = {
  id: "1",
  title: "React開発案件",
  features: ["フルリモート可"],
  skills: ["React", "TypeScript"],
  rate: "800000",
  recruitmentStatus: "募集中",
}
```

---

## CI/CD

### GitHub Actionsワークフロー

#### テストワークフロー（.github/workflows/test.yml）

```yaml
トリガー: push/PR to develop, main

ジョブ:
1. lint
   - ESLint実行
   - TypeScriptチェック

2. unit-test（lintの後）
   - Jestテスト実行
   - カバレッジレポート生成
   - カバレッジをartifactとして保存

3. test-summary
   - 結果サマリー出力
```

#### デプロイワークフロー（.github/workflows/deploy-apprunner.yml）

```yaml
トリガー: push to develop, main

ジョブ:
1. test
   - ESLint実行
   - TypeScriptチェック
   - Jestテスト実行
   ※テスト失敗時はデプロイをスキップ

2. deploy（testの後）
   - Dockerイメージビルド
   - ECRにプッシュ
   - App Runnerにデプロイ
```

### 環境変数（CI用）

```yaml
# テスト実行に必要な環境変数（.github/workflows/test.yml）
KINTONE_BASE_URL: 'https://example.cybozu.com'
KINTONE_TALENT_API_TOKEN: 'test-token'
KINTONE_TALENT_APP_ID: '1'
KINTONE_JOB_API_TOKEN: 'test-token'
KINTONE_JOB_APP_ID: '2'
KINTONE_APPLICATION_API_TOKEN: 'test-token'
KINTONE_APPLICATION_APP_ID: '3'
KINTONE_RECOMMENDATION_API_TOKEN: 'test-token'
KINTONE_RECOMMENDATION_APP_ID: '4'
NEXT_PUBLIC_APP_URL: 'http://localhost:3000'
BETTER_AUTH_SECRET: 'test-secret-key-for-ci-must-be-32-chars-minimum'
```

---

## トラブルシューティング

### テストが「Cannot find module」エラーで失敗する

```bash
npm install
rm -rf node_modules/.vitest
npm test
```

### モックが効いていない

```typescript
// vi.mockはファイルの先頭（importより前）に配置
vi.mock('@/lib/auth-server', () => ({
  getSession: vi.fn(() => mockSession),
}))

// beforeEachでモックをリセット
beforeEach(() => {
  vi.clearAllMocks()
})
```

### E2Eテストがタイムアウトする

```bash
# 開発サーバーが起動しているか確認
npm run dev

# タイムアウトを延長
npx playwright test --timeout=60000

# 特定のテストのみ実行
npx playwright test tests/e2e/auth.spec.ts
```

### E2Eテストがサーバー未起動でエラーになる

```bash
# サーバーを起動してからテスト実行
npm run dev &
sleep 10
npm run test:e2e
```

---

## ベストプラクティス

### 1. テストは独立させる

```typescript
beforeEach(() => {
  vi.clearAllMocks()
  vi.mocked(getSession).mockResolvedValue(mockSession)
})
```

### 2. わかりやすいテスト名を使う

```typescript
// 良い例
it('未認証の場合は401エラーを返す', async () => {})
it('存在しない案件の場合は404エラーを返す', async () => {})
```

### 3. describeでテストケースIDを管理

```typescript
// 良い例 - ドキュメントのIDと対応
describe("4.1.1 案件への応募", () => {
  it("ログインユーザーが案件に応募できる", async () => {})
})
```

### 4. エラーケースも必ずテストする

```typescript
it('Kintoneエラー時は500を返す', async () => {
  vi.mocked(getAllJobs).mockRejectedValue(new Error('Kintone API Error'))
  const response = await GET(request)
  expect(response.status).toBe(500)
})
```

### 5. 非同期処理はawaitで待つ

```typescript
it('メール送信が完了する', async () => {
  await POST(request)

  // 非同期処理の完了を待つ
  await new Promise((resolve) => setTimeout(resolve, 10))

  expect(sendEmail).toHaveBeenCalled()
})
```

---

## 関連ドキュメント

- [Vitest公式ドキュメント](https://vitest.dev/)
- [Playwright公式ドキュメント](https://playwright.dev/)
- [Testing Library](https://testing-library.com/)
