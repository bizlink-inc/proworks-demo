# テスト戦略とCI/CD

## 概要

このプロジェクトでは、3層のテスト戦略を採用しています。

| レイヤー | ツール | 対象 | テスト数 |
|---------|--------|------|----------|
| ユニットテスト | Jest | サービス層、ユーティリティ | 47件 |
| APIテスト | Jest | API Routes（認証、応募、案件、プロフィール） | 62件 |
| E2Eテスト | Playwright | ユーザーフロー（ログイン、応募） | ローカル実行 |

**合計: 109テスト**

---

## テストファイル構成

```
proworks-app/
├── __tests__/
│   ├── api/                          # APIテスト
│   │   ├── applications/
│   │   │   ├── route.test.ts         # POST /api/applications（応募作成）
│   │   │   └── [id]/
│   │   │       └── route.test.ts     # PATCH /api/applications/[id]（応募取消し）
│   │   ├── jobs/
│   │   │   └── route.test.ts         # GET /api/jobs（案件一覧）
│   │   └── me/
│   │       └── route.test.ts         # GET/PATCH /api/me（プロフィール）
│   ├── mocks/                        # 共通モック
│   │   ├── auth.ts                   # 認証モック（Better Auth）
│   │   └── kintone.ts                # Kintoneモック（レコードファクトリ）
│   └── unit/                         # ユニットテスト
│       └── lib/
│           ├── kintone/
│           │   └── services/
│           │       ├── talent.test.ts
│           │       ├── job.test.ts
│           │       ├── application.test.ts
│           │       └── file.test.ts
│           └── utils.test.ts
├── tests/
│   └── e2e/                          # E2Eテスト
│       ├── login-flow.spec.ts        # ログインフロー
│       └── application-flow.spec.ts  # 応募フロー
├── jest.config.js
├── jest.setup.js
└── playwright.config.ts
```

---

## テスト実行コマンド

### 基本コマンド

```bash
# 全テスト実行
npm test

# ウォッチモード（ファイル変更時に自動実行）
npm run test:watch

# カバレッジレポート生成
npm run test:coverage

# E2Eテスト実行（ヘッドレス）
npm run test:e2e

# E2Eテスト（UIモード）
npm run test:e2e:ui
```

### 特定テストの実行

```bash
# APIテストのみ
npm test -- --testPathPattern="api/"

# 応募APIテスト
npm test -- --testPathPattern="applications"

# 案件APIテスト
npm test -- --testPathPattern="jobs"

# ユニットテストのみ
npm test -- --testPathPattern="unit/"
```

---

## APIテスト詳細

### 1. 応募API（POST /api/applications）

| テストケース | 説明 |
|-------------|------|
| 正常系：応募作成成功 | 認証済みユーザーが案件に応募 |
| 異常系：未認証 | 401エラーを返す |
| 異常系：案件が存在しない | 404エラーを返す |
| 異常系：重複応募 | 409エラーを返す |
| 異常系：Kintoneエラー | 500エラーを返す |

### 2. 応募取消しAPI（PATCH /api/applications/[id]）

| テストケース | 説明 |
|-------------|------|
| 正常系：取消し成功 | ステータスを「応募取消し」に更新 |
| 異常系：未認証 | 401エラーを返す |
| 異常系：他人の応募 | 404エラーを返す |
| 異常系：取消し不可ステータス | 400エラーを返す（面談調整中など） |
| 異常系：Kintoneエラー | 500エラーを返す |

### 3. 案件一覧API（GET /api/jobs）

| テストケース | 説明 |
|-------------|------|
| 正常系：全件取得 | 案件一覧を返す |
| フィルタ：応募済み除外 | 応募した案件を除外 |
| フィルタ：クローズ除外 | 募集終了案件を除外 |
| 検索：キーワード | AND検索で絞り込み |
| 検索：リモート可否 | リモートワーク条件でフィルタ |
| 検索：職種 | ポジションでフィルタ |
| 検索：勤務地 | エリアで部分一致検索 |
| ソート：おすすめ順 | マッチ度→担当者おすすめ→新着順 |
| ソート：新着順 | 作成日時降順 |
| ソート：単価順 | 掲載単価降順 |
| ページネーション | skip/limit機能 |
| 異常系：Kintoneエラー | 500エラーを返す |

### 4. プロフィールAPI（GET/PATCH /api/me）

| テストケース | 説明 |
|-------------|------|
| GET 正常系 | プロフィール情報を返す |
| GET 未認証 | 401エラーを返す |
| PATCH 正常系 | 全フィールド更新 |
| PATCH 部分更新 | 一部フィールドのみ更新 |
| PATCH 未認証 | 401エラーを返す |

---

## E2Eテスト詳細

### ログインフロー（login-flow.spec.ts）

```typescript
- 正常ログイン：メール/パスワードでログイン成功
- ログアウト：ログアウト後は未認証状態
- 保護ページ：未認証時はリダイレクト
```

### 応募フロー（application-flow.spec.ts）

```typescript
- 案件一覧表示：ログイン後に案件が表示される
- 案件検索：キーワードで検索実行
- 案件詳細表示：カードクリックで詳細モーダル
- 応募実行：応募ボタン→確認→成功（手動確認用）
- 応募履歴表示：応募した案件が一覧に表示
- 応募取消し：取消しボタン→確認→成功（手動確認用）
- 応募済み除外：応募した案件は一覧から除外
```

### E2E実行方法

```bash
# 環境変数でテストユーザーを設定
E2E_TEST_USER_EMAIL=test@example.com \
E2E_TEST_USER_PASSWORD=password123 \
npm run test:e2e
```

---

## モック設計

### 認証モック（__tests__/mocks/auth.ts）

```typescript
import { mockGetSession, setAuthenticated, setUnauthenticated } from '../mocks/auth'

// テストでの使用例
beforeEach(() => {
  setAuthenticated()  // 認証済み状態
})

it('未認証の場合は401', async () => {
  setUnauthenticated()  // 未認証状態に切り替え
  const response = await GET(request)
  expect(response.status).toBe(401)
})
```

### Kintoneモック（__tests__/mocks/kintone.ts）

```typescript
import { createMockJob, createMockApplication, createMockTalent } from '../mocks/kintone'

// レコードファクトリの使用例
const job = createMockJob({
  id: 'job-123',
  title: 'React開発者募集',
  requiredSkills: 'React, TypeScript',
})

const application = createMockApplication({
  jobId: 'job-123',
  status: '応募済み',
})
```

---

## CI/CD

### GitHub Actionsワークフロー

#### 1. テストワークフロー（.github/workflows/test.yml）

```yaml
トリガー: push/PR to develop, main

ジョブ:
1. lint
   - ESLint実行
   - TypeScriptチェック

2. unit-test（lintの後）
   - Jestテスト実行
   - カバレッジレポート生成
   - カバレッジをartifactとして保存

3. test-summary
   - 結果サマリー出力
```

#### 2. デプロイワークフロー（.github/workflows/deploy-apprunner.yml）

```yaml
トリガー: push to develop, main

ジョブ:
1. test
   - ESLint実行
   - TypeScriptチェック
   - Jestテスト実行
   ※テスト失敗時はデプロイをスキップ

2. deploy（testの後）
   - Dockerイメージビルド
   - ECRにプッシュ
   - App Runnerにデプロイ
```

### 環境変数（CI用）

```yaml
# テスト実行に必要な環境変数（.github/workflows/test.yml）
KINTONE_BASE_URL: 'https://example.cybozu.com'
KINTONE_TALENT_API_TOKEN: 'test-token'
KINTONE_TALENT_APP_ID: '1'
KINTONE_JOB_API_TOKEN: 'test-token'
KINTONE_JOB_APP_ID: '2'
KINTONE_APPLICATION_API_TOKEN: 'test-token'
KINTONE_APPLICATION_APP_ID: '3'
KINTONE_RECOMMENDATION_API_TOKEN: 'test-token'
KINTONE_RECOMMENDATION_APP_ID: '4'
NEXT_PUBLIC_APP_URL: 'http://localhost:3000'
BETTER_AUTH_SECRET: 'test-secret-key-for-ci-must-be-32-chars-minimum'
```

---

## ユニットテスト詳細

### 1. 人材情報サービス（talent.test.ts）

- auth_user_idで人材情報を正常に取得
- 存在しないユーザーはnull返却
- kintoneエラー時はエラースロー
- 職務経歴書データが空の場合は空配列返却
- 新しい人材情報を正常に作成
- 空フィールドの場合、メールアドレスから氏名を生成
- 人材情報を正常に更新
- 部分的なフィールド更新が可能
- 更新時のkintoneエラー処理

### 2. 案件情報サービス（job.test.ts）

- すべての案件を正常に取得
- 案件が0件の場合は空配列返却
- IDで案件詳細を正常に取得
- 存在しない案件IDはnullを返す
- 取得エラー時の例外処理

### 3. 応募履歴サービス（application.test.ts）

- auth_user_idで応募履歴を取得
- 応募履歴が0件の場合は空配列を返す
- 新しい応募を作成
- 重複がある場合はtrue、ない場合はfalseを返す
- kintoneエラー時はエラーをスロー

### 4. ファイルサービス（file.test.ts）

- PDFファイルのアップロード
- Wordファイル（.docx）のアップロード
- 対応していないファイル形式の拒否
- 10MBを超えるファイルの拒否
- ファイルのダウンロード
- Bufferデータの正常な変換
- ファイル情報の取得
- エラーが発生したファイルの除外処理
- ファイルサイズのフォーマット

### 5. ユーティリティ（utils.test.ts）

- 複数クラス名の結合
- 条件付きクラス追加
- Tailwind CSSクラスのマージ
- 配列でのクラス指定
- オブジェクトでの条件付きクラス指定

---

## トラブルシューティング

### テストが「Cannot find module」エラーで失敗する

```bash
npm install --legacy-peer-deps
npm test -- --clearCache
```

### モックが効いていない

```typescript
// jest.setup.jsでモックが正しく設定されているか確認
jest.mock('@/lib/auth', () => ({
  auth: { api: { getSession: jest.fn() } }
}))

// beforeEachでモックをリセット
beforeEach(() => {
  jest.clearAllMocks()
})
```

### E2Eテストがタイムアウトする

```bash
# タイムアウトを延長
npx playwright test --timeout=60000

# または特定のテストのみ実行
npx playwright test login-flow.spec.ts
```

---

## ベストプラクティス

### 1. テストは独立させる

```typescript
beforeEach(() => {
  jest.clearAllMocks()
  setAuthenticated()
})
```

### 2. わかりやすいテスト名を使う

```typescript
// 良い例
it('未認証の場合は401エラーを返す', async () => {})
it('重複応募の場合は409エラーを返す', async () => {})
```

### 3. モックはファクトリ関数で作成

```typescript
// 良い例
const job = createMockJob({ title: 'テスト案件' })

// 悪い例
const job = { id: '1', title: 'テスト', ... } // 長い
```

### 4. エラーケースも必ずテストする

```typescript
it('Kintoneエラー時は500を返す', async () => {
  mockGetAllJobs.mockRejectedValue(new Error('Kintone API Error'))
  const response = await GET(request)
  expect(response.status).toBe(500)
})
```

---

## 関連ドキュメント

- [Jest公式ドキュメント](https://jestjs.io/)
- [Playwright公式ドキュメント](https://playwright.dev/)
- [Testing Library](https://testing-library.com/)
