# シードデータ管理

このドキュメントでは、開発・テスト用のシードデータの作成・削除方法について説明します。

## 🎯 シードデータ構成

| コマンド              | 人材数 | 案件数 | 用途                        |
| --------------------- | ------ | ------ | --------------------------- |
| `npm run seed:create` | 51 人  | 55 件  | Yamada(1+5) + 大規模(50+50) |

**注**: 推薦 DB は管理画面から「候補者抽出」ボタンで動的に作成されます。

## 🔐 ログイン情報

### 管理者ログイン

| メールアドレス      | パスワード | URL            |
| ------------------- | ---------- | -------------- |
| `admin@example.com` | `admin123` | `/admin/login` |

### シードデータユーザー（小規模テスト用）

| 名前      | メールアドレス            | パスワード    |
| --------- | ------------------------- | ------------- |
| 山田 太郎 | `seed_yamada@example.com` | `password123` |
| 田中 花子 | `seed_hanako@example.com` | `password123` |

### シードデータユーザー（大規模テスト用）

50 名（`seed_talent_001@example.com` 〜 `seed_talent_050@example.com`、全員 `password123`）

---

## 📋 シードデータの内容

### Yamada データ（小規模テスト用）

#### Better Auth ユーザー: 2 件

| 名前      | メールアドレス            | パスワード    |
| --------- | ------------------------- | ------------- |
| 山田 太郎 | `seed_yamada@example.com` | `password123` |
| 田中 花子 | `seed_hanako@example.com` | `password123` |

#### kintone 人材 DB: 1 件

| 人材      | スキル                                         |
| --------- | ---------------------------------------------- |
| 山田 太郎 | JavaScript, TypeScript, React, Next.js, Python |

#### kintone 案件 DB: 5 件

#### kintone 応募履歴 DB: 3 件

---

### 大規模データ（本番規模テスト用）

#### Better Auth ユーザー: 50 件

| カテゴリ          | 人材数 | パターン                                |
| ----------------- | ------ | --------------------------------------- |
| フロントエンド    | 10 人  | React, Vue, Angular, TypeScript 等      |
| バックエンド      | 10 人  | Python, Java, Go, Node.js, PHP 等       |
| インフラ/クラウド | 10 人  | AWS, GCP, Azure, Docker, Kubernetes 等  |
| モバイル          | 10 人  | React Native, Flutter, Swift, Kotlin 等 |
| データ/AI         | 10 人  | Python, TensorFlow, BigQuery 等         |

#### kintone 人材 DB: 50 件

各カテゴリで 10 人の人材を生成。各人材には：

- メインスキル: 該当カテゴリのスキル
- サブスキル: 他カテゴリのスキル（バラツキ演出用）

#### kintone 案件 DB: 50 件

各カテゴリで 10 件の案件を生成。カテゴリ別にマッチング度合いが変わる設計

#### kintone 応募履歴 DB: 5 件

各カテゴリから 1 件のみ（テスト用）

---

## 🚀 シードデータ作成

```bash
# シードデータを作成（削除 + 作成）
npm run seed:create
```

### 作成時間目安

| ユーザー作成 | Kintone 作成 | 合計    |
| ------------ | ------------ | ------- |
| < 1 秒       | 数秒         | 5-10 秒 |

### 実装の特徴

- **ユーザー作成**: SQLite トランザクションで一括作成（HTTP リクエスト不要）
- **Kintone レコード作成**: `addRecords` で一括作成（1 回の API 呼び出し）
- **推薦データ**: 管理画面から「候補者抽出」で動的に作成

## 🗑️ シードデータ削除

```bash
# シードデータを削除
npm run seed:delete
```

### 削除される内容

1. kintone 推薦 DB のレコード削除（設定されている場合）
2. kintone 応募履歴 DB のレコード削除
3. kintone 案件 DB のレコード削除
4. kintone 人材 DB のレコード削除
5. Better Auth のユーザーとセッションデータ削除

---

## 🎯 候補者抽出機能

推薦データは事前に作成されず、管理画面から動的に作成されます。

### フロー

1. **案件担当者が案件詳細を開く**
2. **「候補者抽出」を押す**
   - マッチングスコア計算が実行される
   - 推薦 DB にレコードが作成される
3. **上位 10 人の候補者が表示される**
4. **3〜5 人を選択**
5. **「AI マッチ実行」ボタンを押す**（未実装）

### マッチングスコア計算ロジック

#### 参照フィールド

**案件側（検索キーワード）**:

- `職種_ポジション`（複数選択）
- `スキル`（複数選択）

**人材側（検索対象）**:

- `職種`（複数選択）
- `言語_ツール`（テキスト）
- `主な実績_PR_職務経歴`（テキスト）

#### スコア計算

1. 案件の「職種\_ポジション」と「スキル」からキーワードを抽出
2. 各キーワードが人材の各フィールドに何回出現するかカウント
3. 全キーワードの出現回数を合計 = スコア

**例**:

- 案件: `職種_ポジション: ["フロントエンド"], スキル: ["React", "TypeScript"]`
- 人材 A: `言語_ツール: "React, TypeScript, Next.js"`
  - "React" → 1 回、"TypeScript" → 1 回
  - スコア = 2

---

## ⚠️ 注意事項

### 環境変数の確認

シードデータ作成前に、以下の環境変数が設定されていることを確認してください：

```bash
# .env.local
KINTONE_BASE_URL=https://your-domain.cybozu.com

# 必須アプリ
KINTONE_TALENT_APP_ID=81
KINTONE_JOB_APP_ID=85
KINTONE_APPLICATION_APP_ID=84
KINTONE_TALENT_API_TOKEN=your_talent_token
KINTONE_JOB_API_TOKEN=your_job_token
KINTONE_APPLICATION_API_TOKEN=your_application_token

# 推薦DB（候補者抽出機能で使用）
KINTONE_RECOMMENDATION_APP_ID=97
KINTONE_RECOMMENDATION_API_TOKEN=your_recommendation_token
```

### API トークンの権限

各 kintone アプリの API トークンに以下の権限が必要です：

- **レコード閲覧**: ✅
- **レコード追加**: ✅
- **レコード編集**: ✅
- **レコード削除**: ✅

### 案件 DB のスキルフィールド

案件 DB に「スキル」フィールド（チェックボックス or 複数選択）が必要です。

## 🔧 トラブルシューティング

### よくあるエラー

#### 1. 環境変数エラー

```
❌ KINTONE_BASE_URL が設定されていません
```

**解決方法**: `.env.local` ファイルに環境変数を設定してください。

#### 2. API トークンエラー

```
❌ [403] このAPIトークンでは、指定したAPIを実行できません。
```

**解決方法**: kintone アプリの設定で、API トークンに必要な権限を付与してください。

#### 3. スキルフィールドエラー

```
❌ [520] 指定したフィールドコードが見つかりません。（スキル）
```

**解決方法**: 案件 DB に「スキル」フィールドを追加してください。

#### 4. 重複ユーザーエラー

```
❌ User already exists. Use another email.
```

**解決方法**: 既存のユーザーを削除してから再作成してください。

```bash
npm run seed:delete
npm run seed:create
```

## 🔄 開発フロー例

```bash
# 1. 開発開始時：シードデータを作成
npm run seed:create

# 2. 管理者ページで確認
# http://localhost:3000/admin/login

# 3. 案件を選択し「候補者抽出」をクリック
# - マッチングスコアが計算される
# - 上位10人の候補者が表示される

# 4. 3〜5人を選択して「AIマッチ実行」
# （現在は未実装）

# 5. 開発終了時：全データ削除
npm run seed:delete
```

## 💡 パフォーマンス最適化

### Kintone API 最適化

- **一括作成**: `addRecords` で 100 件ずつ処理
- **一括更新**: `updateRecords` で 100 件ずつ処理
- **一括削除**: `deleteRecords` で 100 件ずつ処理

### Better Auth 最適化

- **トランザクション**: SQLite トランザクションで全ユーザーを一括挿入
- **パスワードハッシュ**: 共通パスワードなので 1 回だけハッシュ化

---
