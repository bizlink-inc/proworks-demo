# 環境変数設定ガイド

## 概要

このプロジェクトは複数の外部サービスと連携しています。それぞれのサービスから取得したAPIキーやトークンを環境変数として設定する必要があります。

⚠️ **重要：機密情報の取り扱い**
- `.env.local` ファイルには実際のAPIキーやトークンが含まれます
- このファイルは `.gitignore` で保護されており、Gitに追跡されません
- **リポジトリに機密情報をコミットしないよう注意してください**

---

## セットアップ手順

### 1️⃣ `.env.local` ファイルを作成

```bash
cp .env.example .env.local
```

### 2️⃣ 各サービスのAPIキーを取得して設定

以下のセクションを参照して、それぞれのサービスからAPIキーを取得し、`.env.local` に記入してください。

---

## 環境変数一覧

### 🔧 アプリケーション設定

```env
NODE_ENV=development
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

| 環境変数 | 説明 | 取得方法 |
|---------|------|---------|
| `NODE_ENV` | 実行環境（development/production） | 固定値 |
| `NEXT_PUBLIC_APP_URL` | アプリケーションのURL | ローカル開発時は `http://localhost:3000` |

---

### 🔐 Better Auth 設定

```env
BETTER_AUTH_SECRET=your-secret-key-here
```

**説明：** ユーザー認証・セッション管理用の秘密鍵

**取得方法：** 以下のコマンドで新しい秘密鍵を生成

```bash
openssl rand -base64 32
```

**出力例：**
```
R7tBaUpnfiH83N2ErSTtwhKhHVd324ehN/hvQ2PxdpE=
```

---

### 📋 Kintone 設定

```env
KINTONE_BASE_URL=https://your-subdomain.cybozu.com
KINTONE_TALENT_APP_ID=81
KINTONE_TALENT_API_TOKEN=your_token_here
KINTONE_JOB_APP_ID=85
KINTONE_JOB_API_TOKEN=your_token_here
KINTONE_APPLICATION_APP_ID=84
KINTONE_APPLICATION_API_TOKEN=your_token_here
KINTONE_RECOMMENDATION_APP_ID=97
KINTONE_RECOMMENDATION_API_TOKEN=your_token_here
```

**説明：** 人材・案件情報を管理するKintoneアプリの設定

**取得方法：**

1. **Kintone環境にログイン** → https://your-subdomain.cybozu.com
2. 各アプリケーションを開く
3. **アプリID** を確認
   - ブラウザのURLから確認できます
   - 例：`https://your-subdomain.cybozu.com/k/81/` → App ID: `81`
4. **APIトークン** を生成
   - 各アプリケーションの設定 → APIトークン → 生成

**参考資料：** `scripts/kintone-fields/README.md`

---

### 📧 SendGrid 設定

```env
SENDGRID_API_KEY=SG_your_sendgrid_key
```

**説明：** メール送信サービス用のAPIキー

**取得方法：**

1. **SendGrid コンソールにログイン** → https://app.sendgrid.com
2. **Settings → API Keys** に移動
3. **Create API Key** をクリック
4. 必要な権限を選択して生成

**ローカル開発環境での注意：**
- ダミー値（`SG_dummy_key_for_development`）を使用可能
- 実際のメール送信をテストする場合は、実際のAPIキーを設定してください

---

### 🤖 Gemini AI 設定

```env
GEMINI_API_KEY=your_gemini_api_key
```

**説明：** Google Gemini APIのキー（AIマッチング機能で使用）

**取得方法：**

1. **Google AI Studio にアクセス** → https://ai.google.dev
2. **Get API Key** をクリック
3. **Create new API key** を選択
4. 生成されたキーをコピー

**⚠️ クォータ制限について：**

Gemini APIの無料枠には以下の制限があります：

- **入力トークン数：** 初月 1,000万トークン
- **リクエスト数：** 初月 1,500リクエスト/分（バースト制限）

**制限を超えた場合の対応：**

1. **有料プランへのアップグレード**
   - Google Cloud Console → Billing → Upgrade Project
2. **API呼び出し数の削減**
   - キャッシング機構の導入
   - レート制限の実装
   - バッチ処理の最適化

**使用状況の確認方法：**

```bash
# Google Cloud CLIをインストール（初回のみ）
curl https://sdk.cloud.google.com | bash

# ログイン
gcloud auth login

# プロジェクトを設定
gcloud config set project YOUR_PROJECT_ID

# 使用状況を確認
open "https://console.cloud.google.com/apis/api/generativelanguage.googleapis.com/metrics"
```

---

## セキュリティのベストプラクティス

### ✅ 推奨事項

- ✅ `.env.local` は絶対にGitにコミットしない（`.gitignore` で保護済み）
- ✅ 機密情報を他のメンバーに共有する場合は、安全なチャネルを使用
- ✅ 定期的にAPIキーをローテーション（特に本番環境）
- ✅ 不要になったキーは即座に削除
- ✅ 環境変数の値をログ出力しない

### ❌ 避けるべきこと

- ❌ コードに機密情報をハードコードしない
- ❌ `.env.local` をSlackやメールで共有しない
- ❌ リポジトリに機密情報を含めない
- ❌ 本番環境のキーを開発環境で使用しない

---

## トラブルシューティング

### Kintoneの設定がうまくいかない場合

```bash
# Kintoneのフィールド構造を確認
npm run get-kintone-fields
```

詳細は `scripts/kintone-fields/README.md` を参照

### Gemini APIのエラーが発生した場合

#### エラー: 429 (クォータ超過)

```
Gemini API エラー: 429 {
  "message": "You exceeded your current quota..."
}
```

**対応方法：**

1. 無料枠のクォータを確認
2. 有料プランへのアップグレードを検討
3. 一時的に機能を停止してクォータ回復を待つ

#### エラー: 401 (認証失敗)

```
Gemini API エラー: 401 {
  "message": "Invalid API key"
}
```

**対応方法：**

1. APIキーが正しいか確認
2. APIキーが有効期限切れでないか確認
3. 新しいAPIキーを再生成

---

## 参考リンク

- [Google AI Studio](https://ai.google.dev)
- [Kintone API ドキュメント](https://kintone.io/developers)
- [SendGrid API ドキュメント](https://docs.sendgrid.com/api-reference)
- [Better Auth ドキュメント](https://www.betterauth.dev)
