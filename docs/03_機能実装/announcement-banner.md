# お知らせバナー機能 実装ドキュメント

## 概要

トップページにシステム通知（お知らせ、メンテナンス、障害）を表示するバナー機能を実装しました。

## 機能仕様

### 表示条件

- **掲載期間**: `掲載開始日 <= 今日 <= 掲載終了日` の条件を満たすレコードを表示
- **掲載種別**: お知らせ、メンテナンス、障害のすべての種別を対象
- **表示順序**: `掲載開始日 desc, 掲載終了日 asc` でソート

### 表示ロジック

1. **複数件ある場合**: 1件ずつ順番に表示
   - 最初の1件を表示
   - ×ボタンを押すと、フェードアウトアニメーション後に次の1件を表示
   - すべて閉じるまで繰り返し

2. **件数表示**:
   - もともと2件以上ある場合: 「○件中○件目」と表示
   - もともと1件しかない場合: 件数表示なし
   - 複数件ある場合の最後の1件: 「○件中○件目」と表示（例: 「4件中4件目」）

3. **キャッシュ機能**:
   - ×ボタンを押したお知らせはローカルストレージに保存
   - 次回ページ読み込み時、閉じたお知らせは表示されない
   - 開発用にキャッシュクリアコマンドを用意

### UI仕様

- **背景色**: `var(--pw-bg-pink-lighter)`
- **種別タグ**: 赤背景（`var(--pw-alert-error)`）、白文字
- **メッセージ本文**: 赤文字（`var(--pw-alert-error)`）、太字（font-weight: 600）
- **日付表示**: `M/d(曜日)` 形式（例: `12/22(日)`）
- **アニメーション**: フェードアウト/フェードイン（300ms）

## 技術実装

### ファイル構成

```
proworks-app/
├── components/
│   └── announcement-banner.tsx      # お知らせバナーコンポーネント
├── app/
│   └── api/
│       └── announcements/
│           └── route.ts             # お知らせ取得API
│       └── dev/
│           └── clear-announcement-cache/
│               └── route.ts         # 開発用キャッシュクリアAPI
├── lib/
│   └── kintone/
│       ├── client.ts                # kintoneクライアント（システム通知用追加）
│       ├── types.ts                 # 型定義（AnnouncementRecord, Announcement追加）
│       └── services/
│           └── announcement.ts      # お知らせ取得サービス
└── scripts/
    ├── seed-data.ts                 # シードデータ作成（システム通知4件追加）
    └── clear-announcement-cache.ts  # キャッシュクリアスクリプト
```

### kintone連携

#### アプリ設定

- **App ID**: `98`
- **App Name**: システム通知
- **環境変数**:
  - `KINTONE_ANNOUNCEMENT_APP_ID=98`
  - `KINTONE_ANNOUNCEMENT_API_TOKEN=Gec5uPvb0PxXFoYiN2ylifFvb1hnZfdZkdOE5KRA`

#### フィールド構成

| フィールド名 | フィールドタイプ | 説明 |
|------------|----------------|------|
| 掲載種別 | プルダウン | お知らせ、メンテナンス、障害 |
| 掲載開始日 | 日付 | yyyy-MM-dd形式 |
| 掲載終了日 | 日付 | yyyy-MM-dd形式 |
| 通知内容 | 文字列（1行） | お知らせの本文 |

#### クエリ仕様

```javascript
掲載開始日 <= "${todayStr}" and 掲載終了日 >= "${todayStr}" 
order by 掲載開始日 desc, 掲載終了日 asc
```

### API仕様

#### GET /api/announcements

お知らせ一覧を取得するAPIエンドポイント。

**レスポンス例**:
```json
{
  "announcements": [
    {
      "id": "123",
      "type": "お知らせ",
      "startDate": "2025-12-22",
      "endDate": "2026-01-22",
      "content": "システムの新機能が追加されました。"
    }
  ]
}
```

#### GET /api/dev/clear-announcement-cache

開発用: お知らせのキャッシュをクリアするエンドポイント。
ブラウザでアクセスすると、ローカルストレージをクリアしてトップページにリダイレクトします。

### コンポーネント仕様

#### AnnouncementBanner

**Props**: なし

**State**:
- `announcements`: 表示対象のお知らせリスト
- `isClosing`: 閉じるアニメーション中かどうか
- `isAnimating`: アニメーション中かどうか
- `totalCount`: 初期の全件数（変更しない）
- `currentIndex`: 現在表示中の位置（1件目から開始）

**主要な処理**:
1. `useEffect`: ページ読み込み時にAPIからお知らせを取得
2. `handleClose`: ×ボタンクリック時の処理
   - ローカルストレージに保存
   - フェードアウトアニメーション
   - リストから削除
   - 次のお知らせをフェードイン

### シードデータ

`npm run seed:create` 実行時に、以下の4件のお知らせが作成されます：

1. **お知らせ1**: 掲載開始日=当日、掲載終了日=1ヶ月後
2. **メンテナンス**: 掲載開始日=当日、掲載終了日=1ヶ月後
3. **お知らせ2**: 掲載開始日=当日、掲載終了日=1ヶ月後
4. **障害**: 掲載開始日=当日、掲載終了日=1ヶ月後

すべて表示される設定になっています。

## 開発用コマンド

### キャッシュクリア

```bash
npm run cache:clear:announcements
```

このコマンドを実行すると、ブラウザでキャッシュクリアページが開き、自動的にローカルストレージをクリアしてトップページにリダイレクトされます。

## 実装のポイント

1. **日付処理**: 日本時間（JST）で今日の日付を取得し、kintoneの日付フィールドと比較
2. **アニメーション**: フェードアウト/フェードインで視覚的な遷移を実現
3. **状態管理**: 全件数と現在の位置を別々に管理し、正しい件数表示を実現
4. **キャッシュ管理**: ローカルストレージでユーザーの閉じたお知らせを永続化
5. **開発体験**: 開発用のキャッシュクリア機能でテストを容易に

## 今後の拡張可能性

- お知らせの詳細ページへのリンク
- お知らせの重要度による表示優先順位
- お知らせの既読/未読管理
- お知らせのカテゴリ別フィルタリング

