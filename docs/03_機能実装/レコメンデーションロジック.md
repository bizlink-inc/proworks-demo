# 推薦ロジック仕様書

このドキュメントでは、案件と人材のマッチングスコアを計算し、推薦 DB に登録するロジックについて説明します。

## 📋 概要

推薦ロジックは、kintone 上の**案件 DB**と**人材 DB**のデータを比較し、各人材が各案件にどの程度適合するかを**スコア**として算出します。算出されたスコアは**推薦 DB**に保存されます。

## 🚀 使用方法

```bash
# 推薦データを作成/更新
npm run recommend:create
```

このコマンドを実行すると：

1. 全ての案件データを取得
2. 全ての人材データを取得
3. 全組み合わせのマッチングスコアを計算
4. 推薦 DB にレコードを登録/更新

## 🔢 スコア計算ロジック

### 参照するフィールド

| DB      | フィールド           | 用途                       |
| ------- | -------------------- | -------------------------- |
| 案件 DB | 職種\_ポジション     | 検索キーワード（複数選択） |
| 案件 DB | スキル               | 検索キーワード（複数選択） |
| 人材 DB | 複数選択（職種）     | 検索対象テキスト           |
| 人材 DB | 言語\_ツール         | 検索対象テキスト           |
| 人材 DB | 主な実績*PR*職務経歴 | 検索対象テキスト           |

### 計算方法

1. **キーワード抽出**: 案件の「職種\_ポジション」と「スキル」から検索キーワードを収集
2. **テキスト検索**: 各キーワードが人材の 3 つのフィールドに何回出現するかをカウント
3. **スコア合計**: 全キーワードの出現回数を合計してスコアとする

### 計算例

**案件データ**:

- 職種\_ポジション: `["データベースエンジニア", "インフラエンジニア"]`
- スキル: `["Python", "BigQuery", "AWS"]`

**人材データ**:

- 職種: `["インフラ", "開発"]`
- 言語\_ツール: `"Python, Django, FastAPI, PostgreSQL, AWS, Docker"`
- 主な実績*PR*職務経歴:

  ```
  【経歴概要】
  データエンジニアとして9年の実務経験があります。
  大規模データ基盤の構築・運用が得意です。

  【主なプロジェクト】
  ・データレイク/データウェアハウスの設計・構築（AWS + BigQuery）
  ・ETLパイプラインの自動化（Apache Airflow）
  ・Python を使ったデータ処理基盤の構築
  ```

**スコア計算**:

| キーワード             | 職種 | 言語\_ツール | 職務経歴 | 小計  |
| ---------------------- | ---- | ------------ | -------- | ----- |
| データベースエンジニア | 0    | 0            | 0        | 0     |
| インフラエンジニア     | 0    | 0            | 0        | 0     |
| Python                 | 0    | 1            | 1        | 2     |
| BigQuery               | 0    | 0            | 1        | 1     |
| AWS                    | 0    | 1            | 1        | 2     |
| **合計**               |      |              |          | **5** |

※ 「インフラ」は人材の職種に含まれますが、キーワードは「インフラエンジニア」なので部分一致でカウントされます。

### 部分一致について

- 検索は**大文字小文字を区別しない**
- キーワードが文字列内に含まれていれば**部分一致**でカウント
- 例: キーワード「Python」は「Python, Django」や「Python を使った」にマッチ

## 📊 推薦 DB

### フィールド構成

| フィールドコード | 型     | 説明                                     |
| ---------------- | ------ | ---------------------------------------- |
| 人材 ID          | 文字列 | 人材 DB の`auth_user_id`（ルックアップ） |
| 案件 ID          | 数値   | 案件 DB のレコード番号（ルックアップ）   |
| 適合スコア       | 数値   | マッチングスコア                         |

> **注意**: 人材 ID は人材 DB の`$id`（レコード番号）ではなく、`auth_user_id`を使用します。

### 環境変数

```bash
# .env.local
KINTONE_RECOMMENDATION_APP_ID=97
KINTONE_RECOMMENDATION_API_TOKEN=RGizwa6pEfbLigChtI2vGUQ6J2DrErgjnN12G7pf
```

## 🔄 更新ルール

- 同じ人材 ID・案件 ID の組み合わせが既に存在する場合は**上書き更新**
- 存在しない場合は**新規作成**

## 📈 出力例

```
================================================================================
🔢 Step 4: マッチングスコアを計算
================================================================================

📌 案件: データ基盤構築・運用案件
   職種: データベースエンジニア, インフラエンジニア
   スキル: Python, BigQuery, AWS
   → 伊藤 五郎: スコア 12
      - "Python": 3回 [言語_ツール(1), 主な実績_PR_職務経歴(2)]
      - "BigQuery": 2回 [主な実績_PR_職務経歴(2)]
      - "AWS": 3回 [言語_ツール(1), 主な実績_PR_職務経歴(2)]
   → 佐藤 次郎: スコア 4
      - "Python": 2回 [言語_ツール(1), 主な実績_PR_職務経歴(1)]
      - "AWS": 0回
      - "BigQuery": 0回

================================================================================
🎉 推薦データの作成が完了しました！
================================================================================

📊 処理結果:
   👨‍💼 人材数: 5件
   💼 案件数: 5件
   🔢 マッチング組み合わせ: 25件
   ✨ 新規作成: 25件
   🔄 更新: 0件

🏆 スコア上位10件:
   1. 伊藤 五郎 × データ基盤構築・運用案件 = 12点
   2. 田中 一郎 × 大手ECサイトのフロントエンド刷新案件 = 10点
   ...
```

## 🛠 トラブルシューティング

### エラー: KINTONE_RECOMMENDATION_APP_ID が設定されていません

**原因**: 推薦 DB の環境変数が未設定

**解決方法**: `.env.local` に以下を追加

```bash
KINTONE_RECOMMENDATION_APP_ID=97
KINTONE_RECOMMENDATION_API_TOKEN=your_token
```

### エラー: API トークンの権限エラー

**原因**: 推薦 DB の API トークンに必要な権限がない

**解決方法**: kintone アプリ設定で以下の権限を付与

- レコード閲覧: ✅
- レコード追加: ✅
- レコード編集: ✅

### スコアが 0 になる

**原因**: 案件のスキル/職種が未設定、または人材のプロフィールにマッチするキーワードがない

**確認方法**:

1. 案件 DB で「スキル」「職種\_ポジション」が設定されているか確認
2. 人材 DB の「言語*ツール」「主な実績\_PR*職務経歴」にキーワードが含まれているか確認

## 📝 関連ファイル

| ファイル                            | 説明                                               |
| ----------------------------------- | -------------------------------------------------- |
| `scripts/create-recommendations.ts` | 推薦ロジック本体                                   |
| `lib/kintone/client.ts`             | kintone クライアント（createRecommendationClient） |
| `lib/kintone/fieldMapping.ts`       | フィールドマッピング（RECOMMENDATION_FIELDS）      |
| `lib/kintone/types.ts`              | 型定義（RecommendationRecord, Recommendation）     |

## 🔮 今後の拡張案

1. **重み付けスコア**: スキル一致と職種一致で異なる重みを設定
2. **類義語対応**: 「JavaScript」と「JS」を同一視
3. **経験年数考慮**: 職務経歴の年数をスコアに反映
4. **定期実行**: cron ジョブで定期的にスコアを更新
5. **閾値設定**: 一定スコア以上のみ推薦 DB に登録
