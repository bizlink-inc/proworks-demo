# 案件検索機能 実装ガイド

## 概要

ProWorks の案件検索機能は、複数のフィルター条件を組み合わせて、ユーザーが希望する案件を効率的に見つけられるよう設計されています。

**実装日時**: 2025年12月8日  
**関連ファイル**:
- `components/dashboard-filters.tsx` - UIコンポーネント
- `components/dashboard-client.tsx` - ロジック
- `app/api/jobs/route.ts` - バックエンドAPI
- `lib/kintone/types.ts` - 型定義

---

## 検索フィルター仕様

### 1. キーワード検索（フリーワード）

**検索対象フィールド**:
- 案件名 (`title`)
- 作業内容 (`description`)
- 環境 (`environment`)
- 必須スキル (`requiredSkills`)
- 尚可スキル (`preferredSkills`)
- 案件特徴 (`features` 配列内)
- 職種_ポジション (`position` 配列内)

**検索方式**: 部分一致（大文字小文字を区別しない）

```typescript
if (query) {
  const lowerQuery = query.toLowerCase();
  jobs = jobs.filter((job) => {
    return (
      job.title?.toLowerCase().includes(lowerQuery) ||
      job.description?.toLowerCase().includes(lowerQuery) ||
      job.environment?.toLowerCase().includes(lowerQuery) ||
      job.requiredSkills?.toLowerCase().includes(lowerQuery) ||
      job.preferredSkills?.toLowerCase().includes(lowerQuery) ||
      job.features?.some(f => f.toLowerCase().includes(lowerQuery)) ||
      job.position?.some(p => p.toLowerCase().includes(lowerQuery))
    );
  });
}
```

---

### 2. リモート可否フィルター

**選択肢**（案件特徴フィールドから取得）:
- フルリモート可
- リモート併用可
- 常駐案件

**データ構造**: `case.features` 配列内の値

**検索方式**: 配列の要素が完全一致

```typescript
if (remoteFilters.length > 0) {
  jobs = jobs.filter((job) => {
    // 案件特徴（features配列）にフィルター条件のいずれかが含まれるか
    return job.features?.some(feature => remoteFilters.includes(feature));
  });
}
```

**複数選択**: OR 条件（いずれかのリモート条件に合致する案件を表示）

---

### 3. 職種/ポジションフィルター

**表示選択肢**と**Kintone職種_ポジションマッピング**:

| UI表示 | 実際の職種_ポジション値 | 説明 |
|--------|------------------------|------|
| 開発 | 「開発」または「エンジニア」を含む（インフラ除く） | フリーワード的に検索 |
| インフラ | インフラエンジニア | 完全一致 |
| PM・PMO | PM (プロジェクトマネージャー)<br/>PMO (プロジェクト管理支援) | 複数値のOR検索 |
| コンサル | SAPコンサルタント<br/>業務系コンサルタント<br/>ITコンサルタント | 複数値のOR検索 |
| デザイン | Webデザイナー<br/>UI / UXデザイナー | 複数値のOR検索 |
| その他 | 上記以外のすべての職種 | 除外検索 |

**マッピング定義**:

```typescript
export const POSITION_MAPPING: Record<string, string[]> = {
  "開発": [],
  "インフラ": ["インフラエンジニア"],
  "PM・PMO": ["PM (プロジェクトマネージャー)", "PMO (プロジェクト管理支援)"],
  "コンサル": ["SAPコンサルタント", "業務系コンサルタント", "ITコンサルタント"],
  "デザイン": ["Webデザイナー", "UI / UXデザイナー"],
  "その他": [],
}
```

**検索ロジック**:

```typescript
if (positionFilters.length > 0) {
  jobs = jobs.filter((job) => {
    return positionFilters.some(category => {
      const mappedValues = POSITION_MAPPING[category];
      
      // マッピングが空の場合（開発、その他）
      if (!mappedValues || mappedValues.length === 0) {
        if (category === "開発") {
          // 「開発」または「エンジニア」を含む（インフラ除く）
          return job.position?.some(p => 
            p.includes("開発") || 
            (p.includes("エンジニア") && !p.includes("インフラ"))
          );
        }
        if (category === "その他") {
          // 定義されたマッピング以外の職種
          const allMappedPositions = Object.values(POSITION_MAPPING)
            .flat()
            .filter(v => v);
          
          return job.position?.some(p => 
            !allMappedPositions.some(mapped => p.includes(mapped))
          );
        }
        return false;
      }
      
      // マッピングされた値のいずれかが職種_ポジションに含まれるか
      return job.position?.some(p => 
        mappedValues.some(mapped => p.includes(mapped))
      );
    });
  });
}
```

**複数選択**: OR 条件（選択した職種のいずれかに合致する案件を表示）

---

### 4. 勤務地エリアフィルター

**フィールド**: `location` （Kintone の「勤務地エリア」）

**検索方式**: 部分一致（大文字小文字を区別しない）

```typescript
if (location) {
  const locationQuery = location.toLowerCase();
  jobs = jobs.filter((job) => {
    return job.location?.toLowerCase().includes(locationQuery);
  });
}
```

**例**:
- 入力: 「東京」→「東京都渋谷区」などが該当
- 入力: 「神奈川」→「神奈川県横浜市」などが該当

---

### 5. 最寄り駅フィルター

**フィールド**: `nearestStation` （Kintone の「最寄駅」）

**検索方式**: 部分一致、「駅」を除去した上で検索（大文字小文字を区別しない）

```typescript
if (nearestStation) {
  // 入力から"駅"を除去
  const stationQuery = nearestStation.replace(/駅$/g, "").toLowerCase();
  jobs = jobs.filter((job) => {
    if (!job.nearestStation) return false;
    // 案件の最寄駅からも"駅"を除去して部分一致検索
    const jobStation = job.nearestStation.replace(/駅$/g, "").toLowerCase();
    return jobStation.includes(stationQuery);
  });
}
```

**例**:
- 入力: 「渋谷駅」or「渋谷」→「渋谷駅」が該当
- 入力: 「新宿」→「新宿駅」が該当

---

## フロントエンド実装

### UIコンポーネント (`dashboard-filters.tsx`)

**主な機能**:
1. フリーワード検索入力（×ボタンで入力をクリア）
2. リモート可否チェックボックス（複数選択可）
3. 勤務地エリア検索入力
4. 最寄り駅検索入力
5. 職種/ポジションチェックボックス（複数選択可、3列グリッド）
6. 「詳細条件を追加する」トグル（将来の拡張用）
7. 「条件をクリア」ボタン
8. 「この条件で案件検索」ボタン

**レイアウト**:
- 横3カラム（デスクトップ）
- 縦線で区切られた3セクション
- レスポンシブ対応（モバイルで1カラムに変換）

**Props**:
```typescript
type DashboardFiltersProps = {
  onSearch: (filters: JobFilters) => void
  currentSort?: string
}
```

**State**:
```typescript
type JobFilters = {
  query: string          // フリーワード
  sort: string           // ソート順（新着、価格など）
  remote: string[]       // リモート可否
  positions: string[]    // 職種/ポジション
  location: string       // 勤務地エリア
  nearestStation: string // 最寄り駅
}
```

---

## バックエンドAPI (`app/api/jobs/route.ts`)

### エンドポイント

`GET /api/jobs?query=<keyword>&remote=<remote1>,<remote2>&positions=<position1>,<position2>&location=<location>&nearestStation=<station>&sort=<sort>`

### クエリパラメータ

| パラメータ | 型 | 説明 | 例 |
|-----------|-----|------|-----|
| `query` | string | フリーワード検索 | `TypeScript` |
| `remote` | string (カンマ区切り) | リモート可否（複数選択） | `フルリモート可,リモート併用可` |
| `positions` | string (カンマ区切り) | 職種/ポジション（複数選択） | `開発,インフラ` |
| `location` | string | 勤務地エリア | `東京` |
| `nearestStation` | string | 最寄り駅 | `渋谷` |
| `sort` | string | ソート順 | `new`, `price` など |

### レスポンス

```json
{
  "items": [
    {
      "id": "12345",
      "title": "TypeScript/React 開発 フルリモート",
      "features": ["フルリモート可"],
      "position": ["フロントエンド", "フルスタック開発"],
      "location": "東京都渋谷区",
      "nearestStation": "渋谷駅",
      "rate": "800000",
      "applicationStatus": null
    }
  ],
  "total": 45
}
```

---

## ソート処理

現在実装されているソート:
- `sort=new` （デフォルト）: Kintone から取得した順序（新着）
- `sort=price`: 単価が高い順（数値として比較）

**将来実装予定**:
- `おすすめ順`: AI マッチ等による推奨順
- `開始時期`: 案件の開始日が早い順
- `職種順`: 職種別の分類順

---

## データフロー

```
User Input (Dashboard Filters)
    ↓
fetchJobs() [dashboard-client.tsx]
    ↓
URLSearchParams でクエリビルド
    ↓
GET /api/jobs [app/api/jobs/route.ts]
    ↓
getAllJobs() [lib/kintone/services/job.ts] ← Kintone から全案件取得
    ↓
フィルター処理（順序）:
  1. キーワード検索
  2. リモート可否フィルター
  3. 職種/ポジションフィルター
  4. 勤務地エリアフィルター
  5. 最寄り駅フィルター
  6. ソート処理
    ↓
応募済み案件との照合（ログインユーザーのみ）
    ↓
JSON レスポンス
    ↓
setJobs() で状態更新
    ↓
UI 再レンダリング
```

---

## パフォーマンスに関する注意事項

### 現在の実装

- **Kintone から全案件を毎回取得**: フロントエンド側で全件フィルタリング
- **ページネーション**: クライアント側で実施（21件ずつ表示）

### 問題点

- 案件数が増加するとレスポンスが遅くなる可能性
- Kintone API の呼び出し制限の影響

### 将来の最適化案

1. **Kintone のクエリフィルターを活用**
   ```
   query: `案件特徴 in (${features.map(f => `"${f}"`).join(',')}) and 勤務地エリア like "${location}"`
   ```

2. **バックエンド側での完全フィルタリング**
   - API 側ですべてのフィルター処理を実施
   - フロントエンドはレスポンスをそのまま表示

3. **ページング機能の実装**
   - API にページングパラメータ（`limit`, `offset`）を追加
   - Kintone の `offset` 機能を活用

4. **キャッシュの実装**
   - 人気の検索条件をキャッシュ
   - Redis等を活用した短期キャッシュ

---

## テスト項目

### ユニットテスト

- [ ] フリーワード検索が複数フィールドに対応
- [ ] リモート可否フィルターの複数選択（OR条件）
- [ ] 職種/ポジションのマッピングが正しく機能
- [ ] 勤務地エリアの部分一致検索
- [ ] 最寄り駅フィルターで「駅」を正しく除去
- [ ] ソート処理（新着、価格高い順）

### 統合テスト

- [ ] 複数フィルターの同時使用（AND条件）
- [ ] 複数選択フィルターの組み合わせ（OR条件内で）
- [ ] フィルター条件クリア時の動作
- [ ] ページネーション時のフィルター状態保持
- [ ] ログインユーザーの応募済み案件除外

### UIテスト

- [ ] チェックボックスの選択状態が表示に反映
- [ ] 入力フィールドのクリアボタンが機能
- [ ] Enterキーで検索が実行される
- [ ] レスポンシブレイアウトが機能（モバイル/タブレット/デスクトップ）

---

## 関連ファイル

- `components/dashboard-filters.tsx` - 検索UI
- `components/dashboard-client.tsx` - 検索ロジック
- `app/api/jobs/route.ts` - API エンドポイント
- `lib/kintone/services/job.ts` - Kintone API通信
- `lib/kintone/types.ts` - 型定義
- `docs/01_基本設計/ProWorks基本設計.md` - 基本仕様

---

## 更新履歴

| 日時 | 内容 | 実施者 |
|------|------|--------|
| 2025-12-08 | 初版作成・検索機能実装 | - |
