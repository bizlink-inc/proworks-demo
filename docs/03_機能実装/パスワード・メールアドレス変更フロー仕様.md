# パスワード・メールアドレス変更フロー仕様書

## 概要

本ドキュメントでは、ProWorksアプリケーションにおけるパスワード変更・リセット、およびメールアドレス変更のフローについて定義します。

---

## 1. パスワード変更（ログイン後）

### フロー図

```
┌─────────────────────────────────────────────────────────────────────┐
│                    パスワード変更フロー（ログイン後）                  │
└─────────────────────────────────────────────────────────────────────┘

  ┌──────────────────────┐
  │  1. 設定ページ        │
  │  /settings           │
  └──────────┬───────────┘
             │ パスワードセクションで入力
             ▼
  ┌──────────────────────┐
  │ 2. パスワード変更     │
  │ 現在のパスワード入力  │
  │ 新しいパスワード入力  │
  └──────────┬───────────┘
             │ 「パスワードを変更する」ボタン
             ▼
  ┌──────────────────────┐
  │ 3. API処理           │
  │ POST /api/auth/      │
  │      change-password │
  └──────────┬───────────┘
             │ 成功
             ▼
  ┌──────────────────────┐
  │ 4. 自動ログアウト     │
  │ signOut()            │
  └──────────┬───────────┘
             │
             ▼
  ┌──────────────────────┐
  │ 5. ログインページ     │
  │ /auth/signin         │
  │ （再ログインを促す）   │
  └──────────────────────┘
```

### 各ステップの詳細

#### 1. 設定ページ（/settings）

**入力項目**:

| 項目 | 必須 | 入力形式 | 備考 |
|------|:----:|----------|------|
| 現在のパスワード | ✅ | パスワード | 本人確認用 |
| 新しいパスワード | ✅ | パスワード | 12文字以上、大文字・小文字・数字・記号のうち3種類以上 |

**バリデーション**:
- 現在のパスワードが正しいこと
- 新しいパスワードが12文字以上であること
- 新しいパスワードが大文字・小文字・数字・記号のうち3種類以上を含むこと

#### 2. API処理（POST /api/auth/change-password）

**リクエスト**:
```json
{
  "currentPassword": "現在のパスワード",
  "newPassword": "新しいパスワード"
}
```

**処理内容**:
1. 認証状態の確認
2. 現在のパスワードの検証
3. 新しいパスワードのバリデーション
4. パスワードの更新（Better Auth API使用）
5. パスワード変更通知メールの送信

**レスポンス**:
- 成功: 200 OK
- 未認証: 401 Unauthorized
- バリデーションエラー: 400 Bad Request
- パスワード不一致: 400 Bad Request

#### 3. 自動ログアウト

**設計意図**:
- セキュリティのため、パスワード変更後は必ずログアウト
- 新しいパスワードでの再ログインを強制
- 他のデバイスでのセッションも無効化

---

## 2. パスワードリセット（パスワードを忘れた場合）

### フロー図

```
┌─────────────────────────────────────────────────────────────────────┐
│              パスワードリセットフロー（パスワードを忘れた場合）        │
└─────────────────────────────────────────────────────────────────────┘

  ┌──────────────────────┐
  │ 1. ログインページ     │
  │ 「パスワードを忘れた」 │
  │ リンクをクリック      │
  └──────────┬───────────┘
             │
             ▼
  ┌──────────────────────┐
  │ 2. リセット申請画面   │
  │ /auth/forgot-password│
  │ メールアドレス入力    │
  └──────────┬───────────┘
             │ 「リセットリンクを送信」ボタン
             ▼
  ┌──────────────────────┐
  │ 3. メール送信         │
  │ POST /api/auth/      │
  │      forgot-password │
  └──────────┬───────────┘
             │ リセットメール送信
             ▼
  ┌──────────────────────┐
  │ 4. メール確認         │
  │ ユーザーがメール内の  │
  │ リンクをクリック      │
  └──────────┬───────────┘
             │
             ▼
  ┌──────────────────────┐
  │ 5. 新パスワード設定   │
  │ /auth/reset-password │
  │ ?token=xxx           │
  └──────────┬───────────┘
             │ 「パスワードを変更」ボタン
             ▼
  ┌──────────────────────┐
  │ 6. API処理           │
  │ POST /api/auth/      │
  │      reset-password  │
  └──────────┬───────────┘
             │ 成功
             ▼
  ┌──────────────────────┐
  │ 7. ログインページ     │
  │ /auth/signin         │
  │ （再ログインを促す）   │
  └──────────────────────┘
```

### 各ステップの詳細

#### 2. リセット申請画面（/auth/forgot-password）

**入力項目**:

| 項目 | 必須 | 入力形式 | 備考 |
|------|:----:|----------|------|
| メールアドレス | ✅ | Email | 登録済みのメールアドレス |

#### 3. メール送信（POST /api/auth/forgot-password）

**リクエスト**:
```json
{
  "email": "user@example.com"
}
```

**処理内容**:
1. メールアドレスの存在確認（情報漏洩防止のため、存在しなくても成功メッセージを返す）
2. リセットトークンの生成
3. リセットリンク付きメールの送信

**セキュリティ考慮事項**:
- 存在しないメールアドレスでも「送信しました」と応答（アカウント列挙攻撃対策）
- トークンの有効期限は1時間

#### 5. 新パスワード設定画面（/auth/reset-password）

**入力項目**:

| 項目 | 必須 | 入力形式 | 備考 |
|------|:----:|----------|------|
| 新しいパスワード | ✅ | パスワード | 12文字以上、大文字・小文字・数字・記号のうち3種類以上 |
| パスワード確認 | ✅ | パスワード | 新しいパスワードと一致 |

#### 6. API処理（POST /api/auth/reset-password）

**リクエスト**:
```json
{
  "token": "リセットトークン",
  "password": "新しいパスワード"
}
```

**処理内容**:
1. トークンの検証
2. トークンの有効期限確認
3. パスワードの更新（Better Auth API使用）

**レスポンス**:
- 成功: 200 OK
- トークン無効/期限切れ: 400 Bad Request

---

## 3. メールアドレス変更

### フロー図

```
┌─────────────────────────────────────────────────────────────────────┐
│                      メールアドレス変更フロー                         │
└─────────────────────────────────────────────────────────────────────┘

  ┌──────────────────────┐
  │  1. 設定ページ        │
  │  /settings           │
  │ 「メールアドレスを    │
  │  変更する」ボタン     │
  └──────────┬───────────┘
             │ ダイアログを開く
             ▼
  ┌──────────────────────┐
  │ 2. 変更ダイアログ     │
  │ 現在のパスワード入力  │
  │ 新しいメール入力      │
  └──────────┬───────────┘
             │ 「確認メールを送信」ボタン
             ▼
  ┌──────────────────────┐
  │ 3. API処理           │
  │ POST /api/auth/      │
  │      change-email    │
  └──────────┬───────────┘
             │ 確認メール送信
             ▼
  ┌──────────────────────┐
  │ 4. 送信完了表示       │
  │ ダイアログ内で        │
  │ 確認メール送信完了    │
  │ メッセージを表示      │
  └──────────┬───────────┘
             │ ユーザーがメール内リンクをクリック
             ▼
  ┌──────────────────────┐
  │ 5. メール認証         │
  │ /api/auth/           │
  │    verify-email      │
  └──────────┬───────────┘
             │ メールアドレス更新
             ▼
  ┌──────────────────────┐
  │ 6. 変更完了ページ     │
  │ /auth/email-changed  │
  │ 3秒カウントダウン     │
  └──────────┬───────────┘
             │ 自動ログアウト
             ▼
  ┌──────────────────────┐
  │ 7. ログインページ     │
  │ /auth/signin         │
  │ （新メールアドレスで  │
  │  再ログインを促す）   │
  └──────────────────────┘
```

### 各ステップの詳細

#### 2. 変更ダイアログ

**入力項目**:

| 項目 | 必須 | 入力形式 | 備考 |
|------|:----:|----------|------|
| 現在のパスワード | ✅ | パスワード | 本人確認用 |
| 新しいメールアドレス | ✅ | Email | 重複不可 |

**バリデーション**:
- 現在のパスワードが正しいこと
- 新しいメールアドレスが有効な形式であること
- 現在のメールアドレスと異なること
- 新しいメールアドレスが他のユーザーに使用されていないこと

#### 3. API処理（POST /api/auth/change-email）

**リクエスト**:
```json
{
  "currentPassword": "現在のパスワード",
  "newEmail": "new@example.com"
}
```

**処理内容**:
1. 認証状態の確認
2. 現在のパスワードの検証
3. 新しいメールアドレスのバリデーション
4. 確認トークンの生成
5. 新しいメールアドレスに確認メールを送信

**レスポンス**:
- 成功: 200 OK
- 未認証: 401 Unauthorized
- パスワード未入力: 400 Bad Request
- 無効なメール形式: 400 Bad Request
- 同一メール: 400 Bad Request
- パスワード不一致: 400 Bad Request

#### 6. 変更完了ページ（/auth/email-changed）

**表示内容**:
- メールアドレス変更完了メッセージ
- 3秒カウントダウン表示
- 「セキュリティのため、新しいメールアドレスで再度ログインしてください」

**処理内容**:
1. 3秒間のカウントダウン表示
2. 自動でsignOut()を実行
3. ログインページ（/auth/signin）へリダイレクト

**設計意図**:
- セキュリティのため、メールアドレス変更後は必ずログアウト
- 新しいメールアドレスでの再ログインを強制
- 確認リンクの有効期限は1時間

---

## セキュリティ考慮事項

### 共通

| 項目 | 対策 |
|------|------|
| 本人確認 | パスワード変更・メールアドレス変更時は現在のパスワードを要求 |
| セッション無効化 | パスワード・メールアドレス変更後は強制ログアウト |
| トークン有効期限 | リセット・確認トークンは1時間で失効 |
| 情報漏洩防止 | パスワードリセット申請時、メールアドレスの存在有無を漏らさない |

### パスワードポリシー

| 項目 | 要件 |
|------|------|
| 最小文字数 | 12文字以上 |
| 文字種 | 大文字・小文字・数字・記号のうち3種類以上 |

---

## 関連ファイル

### パスワード変更（ログイン後）

| ファイル | 役割 |
|----------|------|
| `components/settings-form.tsx` | 設定ページ（パスワード変更セクション） |
| `app/api/auth/change-password/route.ts` | パスワード変更API |

### パスワードリセット

| ファイル | 役割 |
|----------|------|
| `app/auth/forgot-password/page.tsx` | リセット申請画面 |
| `app/auth/reset-password/page.tsx` | 新パスワード設定画面 |
| `app/api/auth/forgot-password/route.ts` | リセット申請API |
| `app/api/auth/reset-password/route.ts` | パスワードリセットAPI |

### メールアドレス変更

| ファイル | 役割 |
|----------|------|
| `components/settings-form.tsx` | 設定ページ（メールアドレス表示 + 変更ボタン） |
| `components/email-change-dialog.tsx` | メールアドレス変更ダイアログ |
| `app/auth/email-changed/page.tsx` | 変更完了ページ（強制ログアウト） |
| `app/api/auth/change-email/route.ts` | メールアドレス変更API |
| `app/auth/verify-email-change/page.tsx` | メール確認処理 |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-30 | 初版作成。パスワード変更・リセット、メールアドレス変更フローを定義。強制ログアウト処理を追加。 |
