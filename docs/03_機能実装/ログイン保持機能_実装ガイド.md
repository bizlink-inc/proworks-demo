# ログイン保持機能 - 実装ガイド

## 概要

ログイン保持機能により、ユーザーがサインアップ時またはログイン時に「ログイン状態を保持」チェックボックスを有効にした場合、セッションクッキーを30日間有効にする機能です。

---

## 実装内容

### 1. UI レイヤー

#### サインアップページ (`/app/auth/signup/page.tsx`)
- 「ログイン状態を保持」チェックボックスを追加
- フォーム送信時に `rememberMe` フラグをバックエンドに送信

```typescript
// フォーム状態
const [rememberMe, setRememberMe] = useState(false)

// フォーム送信時に rememberMe を含める
body: JSON.stringify({
  // ...その他のフィールド
  rememberMe,
})
```

#### ログインページ (`/app/auth/signin/page.tsx`)
- 既に「ログイン状態を保持」チェックボックスが実装済み
- フォーム送信時に `rememberMe` フラグをバックエンドに送信

---

### 2. バックエンド レイヤー

#### サインアップAPI (`/app/api/auth/signup-with-email/route.ts`)
**処理内容:**
- リクエストから `rememberMe` パラメータを取得
- ユーザー登録後、`rememberMe` が `true` の場合、クッキーを設定

```typescript
// rememberMe が有効な場合、クッキーに情報を保存
if (rememberMe) {
  response.cookies.set("pw_signup_remember", email, {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    sameSite: "lax",
    maxAge: 30 * 24 * 60 * 60, // 30日間
    path: "/",
  });
}
```

**クッキー設定:**
- **名前**: `pw_signup_remember`
- **値**: メールアドレス
- **有効期間**: 30日間
- **セキュリティ**: HttpOnly、SameSite=Lax

---

#### メール認証コールバック (`/app/api/auth/callback/route.ts`)
**処理内容:**
- メール認証完了時に、サインアップクッキーを確認
- クッキーが存在してメールアドレスが一致する場合、拡張セッションクッキーを設定

```typescript
const rememberMeEmail = request.cookies.get("pw_signup_remember")?.value;
const rememberMe = rememberMeEmail === session.user.email;

if (rememberMe) {
  response.cookies.set("pw_extended_session", "true", {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    sameSite: "lax",
    maxAge: 30 * 24 * 60 * 60, // 30日間
    path: "/",
  });
}
```

**クッキー設定:**
- **名前**: `pw_extended_session`
- **値**: "true"
- **有効期間**: 30日間

---

#### ログインAPI (`/app/api/auth/[...all]/route.ts`)
**処理内容:**
- ログイン時に `rememberMe` パラメータを処理
- 認証成功時、`rememberMe` が `true` の場合、クッキーを設定

```typescript
if (rememberMe) {
  response.cookies.set("pw_login_remember", email, {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    sameSite: "lax",
    maxAge: 30 * 24 * 60 * 60, // 30日間
    path: "/",
  });
}
```

**クッキー設定:**
- **名前**: `pw_login_remember`
- **値**: メールアドレス
- **有効期間**: 30日間

---

## データフロー図

```
【サインアップ フロー】

ユーザーがフォーム入力
↓
「ログイン状態を保持」チェックボックスを有効にして送信
↓
サインアップAPI (/api/auth/signup-with-email)
├─ rememberMe = true を受け取る
├─ ユーザー登録実行
└─ pw_signup_remember クッキーを設定（30日間）
↓
メール認証メール送信
↓
ユーザーがメール内のリンクをクリック
↓
メール認証コールバック (/api/auth/callback)
├─ pw_signup_remember クッキーを確認
├─ メールアドレスが一致する場合
└─ pw_extended_session クッキーを設定（30日間）
↓
プロフィール入力画面へリダイレクト
↓
プロフィール完成後、マイページへ遷移
```

```
【ログイン フロー】

ユーザーがメールアドレス・パスワード入力
↓
「ログイン状態を保持」チェックボックスを有効にして送信
↓
ログインAPI (/api/auth/sign-in/email)
├─ rememberMe = true を受け取る
├─ 認証処理実行
└─ pw_login_remember クッキーを設定（30日間）
↓
ダッシュボードへリダイレクト
```

---

## クッキー セキュリティ設定

すべてのログイン保持クッキーは以下の設定で保護されています：

| 設定項目 | 値 | 理由 |
|---------|-----|------|
| HttpOnly | true | JavaScriptからのアクセスを防止 |
| Secure | true (本番のみ) | HTTPS接続でのみ送信 |
| SameSite | Lax | CSRF攻撃を防止 |
| MaxAge | 30日 | 適切なセッション有効期限 |
| Path | "/" | 全ページで有効 |

---

## 使用クッキー一覧

| クッキー名 | 用途 | 有効期間 | タイミング |
|----------|------|---------|----------|
| `pw_signup_remember` | サインアップ時のログイン保持フラグ | 30日間 | サインアップAPI実行時 |
| `pw_extended_session` | メール認証完了時のセッション拡張 | 30日間 | メール認証コールバック実行時 |
| `pw_login_remember` | ログイン時のログイン保持フラグ | 30日間 | ログインAPI実行時 |

---

## テスト方法

### サインアップ時のテスト

1. `/auth/signup` にアクセス
2. フォームを入力
3. 「ログイン状態を保持」チェックボックスを有効にして登録
4. ブラウザの開発者ツール → Application → Cookies で `pw_signup_remember` が設定されていることを確認
5. メールのリンクをクリック
6. `pw_extended_session` が設定されていることを確認

### ログイン時のテスト

1. `/auth/signin` にアクセス
2. メールアドレス・パスワードを入力
3. 「ログイン状態を保持」チェックボックスを有効にしてログイン
4. ブラウザの開発者ツール → Application → Cookies で `pw_login_remember` が設定されていることを確認

---

## 注意点

- **セッション有効期限**: クッキーの有効期限は30日間ですが、Better Authのセッション自体の有効期限が短い場合、セッションが先に失効する可能性があります
- **セキュリティ**: HttpOnly フラグにより、JavaScriptからクッキーにアクセスできません
- **本番環境**: Secure フラグはプロダクション環境でのみ `true` になり、HTTPS接続を強制します

---

## 今後の改善案

1. **セッション有効期限の動的設定**: Better Auth のセッション有効期限を `rememberMe` に基づいて動的に設定
2. **リフレッシュトークン**: 30日以上のセッション延長が必要な場合、リフレッシュトークンの実装
3. **デバイス認識**: 複数デバイス対応の際の追跡機能
4. **セッション強制終了**: 管理画面でのセッション管理機能

---

## 関連ファイル

- `/app/auth/signup/page.tsx` - サインアップUI
- `/app/auth/signin/page.tsx` - ログインUI（既に実装）
- `/app/api/auth/signup-with-email/route.ts` - サインアップAPI
- `/app/api/auth/callback/route.ts` - メール認証コールバック
- `/app/api/auth/[...all]/route.ts` - ログインAPI


