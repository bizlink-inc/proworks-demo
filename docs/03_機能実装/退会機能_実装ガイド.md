# 退会機能 実装ガイド

## 概要

ユーザーが退会した場合、以下の処理が行われます：
1. 問い合わせ・退会DBに退会申請レコードを登録
2. 人材DBのSTフィールドを「退会」に更新
3. 退会完了メールを送信
4. ログアウト処理

退会済みユーザーがログインを試みた場合、ログイン自体がブロックされます。

---

## アーキテクチャ

### 退会処理フロー

```
ユーザーが退会ボタンをクリック
       ↓
確認ダイアログ（2ステップ）
       ↓
POST /api/me/withdraw
       ↓
┌─────────────────────────────────┐
│ 1. 問い合わせDBに退会申請を登録    │
│ 2. 人材DBのSTフィールドを「退会」に │
│ 3. 退会完了メールを送信           │
└─────────────────────────────────┘
       ↓
クライアント側でログアウト → トップページへ
```

### 退会済みユーザーのログインブロック

```
ユーザーがログインを試行
       ↓
パスワード認証 (Better Auth)
       ↓
✅ 認証成功
       ↓
┌─────────────────────────────────┐
│  databaseHooks.session.create   │
│  .before                        │
│  - kintoneでSTフィールドをチェック │
│  - 「退会」なら throw Error      │
└─────────────────────────────────┘
       ↓
❌ セッション作成がキャンセル
       ↓
ログイン画面でエラーメッセージ表示
「このアカウントは退会済みです」
```

---

## 関連ファイル

### バックエンド

| ファイル | 役割 |
|---------|------|
| `lib/auth.ts` | Better AuthのdatabaseHooksで退会ユーザーのログインをブロック |
| `app/api/me/withdraw/route.ts` | 退会処理API |
| `app/api/me/contact/route.ts` | お問い合わせ処理API |
| `lib/kintone/services/inquiry.ts` | 問い合わせ・退会レコードの作成 |
| `lib/kintone/services/talent.ts` | STフィールドの更新 |
| `lib/email.ts` | 退会完了メール送信 |

### フロントエンド

| ファイル | 役割 |
|---------|------|
| `components/withdraw-dialog.tsx` | 退会確認ダイアログ（2ステップ） |
| `components/contact-dialog.tsx` | お問い合わせダイアログ |
| `components/settings-form.tsx` | 設定画面（ダイアログを呼び出し） |
| `hooks/use-withdrawal-check.ts` | 退会済みチェック用フック（フォールバック用） |

### kintone

| アプリ | App ID | 用途 |
|--------|--------|------|
| 人材DB | 環境変数参照 | STフィールドで退会状態を管理 |
| 問い合わせ・退会DB | 101 | 退会申請・お問い合わせ履歴を記録 |

---

## kintone フィールド設計

### 人材DB - STフィールド

| フィールド名 | フィールドコード | 型 | 値 |
|-------------|-----------------|-----|-----|
| ST | ST | 文字列（1行） | 空 or 「退会」 |

### 問い合わせ・退会DB

| フィールド名 | フィールドコード | 型 | 説明 |
|-------------|-----------------|-----|------|
| 種別 | 種別 | ドロップダウン | 「お問い合わせ」「退会申請」 |
| ユーザーID | ユーザーID | ルックアップ | 人材DBのauth_user_idを参照 |
| 氏名 | 氏名 | 文字列 | ルックアップで自動取得 |
| 受付日時 | 受付日時 | 日時 | 申請日時 |
| 対応ステータス | 対応ステータス | ドロップダウン | 未対応/対応中/完了 |
| 問い合わせカテゴリ | 問い合わせカテゴリ | ドロップダウン | お問い合わせ用 |
| 問い合わせ内容 | 問い合わせ内容 | 文字列（複数行） | お問い合わせ用 |
| 退会理由 | 退会理由 | ドロップダウン | 退会用 |
| 退会理由詳細 | 退会理由詳細 | 文字列（複数行） | 退会用 |

---

## 実装詳細

### 1. ログインブロック（lib/auth.ts）

```typescript
// 退会済みユーザーかどうかをkintoneでチェック
const checkWithdrawnUser = async (userId: string): Promise<boolean> => {
  try {
    const client = createTalentClient();
    const appIds = getAppIds();

    const response = await client.record.getRecords({
      app: appIds.talent,
      query: `${TALENT_FIELDS.AUTH_USER_ID} = "${userId}"`,
    });

    if (response.records.length > 0) {
      const record = response.records[0] as any;
      const st = record[TALENT_FIELDS.ST]?.value || "";
      return st === "退会";
    }
    return false;
  } catch (error) {
    console.error("退会チェックエラー:", error);
    return false; // エラー時はログインを許可
  }
};

// Better Auth設定
const auth = betterAuth({
  // ...
  databaseHooks: {
    session: {
      create: {
        before: async (session) => {
          const isWithdrawn = await checkWithdrawnUser(session.userId);
          if (isWithdrawn) {
            throw new Error("このアカウントは退会済みです。");
          }
        },
      },
    },
  },
});
```

### 2. 退会処理API（app/api/me/withdraw/route.ts）

```typescript
export const POST = async (request: NextRequest) => {
  // 1. 問い合わせDBに退会申請を登録
  await createInquiry({
    category: "退会申請",
    userId: session.user.id,
    withdrawalReason: reason,
    withdrawalReasonDetail: reasonDetail,
  });

  // 2. 人材DBのSTフィールドを「退会」に更新
  await updateTalent(talent.id, { st: "退会" });

  // 3. 退会完了メールを送信
  await sendWithdrawalCompletionEmail(talent.email, talent.fullName);

  return NextResponse.json({ success: true });
};
```

### 3. 退会ダイアログ（components/withdraw-dialog.tsx）

- 2ステップ確認フロー
  - Step 1: 確認事項へのチェック + 退会理由入力
  - Step 2: 最終確認
- 全ての確認事項にチェックしないと次へ進めない

---

## SEEDデータのリセット

退会テスト後、Yamadaユーザーを再ログイン可能な状態に復旧するには：

```bash
npm run seed:upsert
```

このコマンドは以下を実行します：
1. 問い合わせ・退会DBの全レコードを削除
2. YamadaのSTフィールドを空にリセット
3. Yamadaユーザー情報をUpsert

---

## 環境変数

```env
# 問い合わせ・退会DB
KINTONE_INQUIRY_APP_ID=101
KINTONE_INQUIRY_API_TOKEN=xxxxxxxx
```

※ ルックアップ機能を使用するため、APIトークンには人材DBへのアクセス権も必要です。
`createInquiryClient()`では問い合わせDBと人材DBの2つのトークンを連結して使用しています。

---

## 注意事項

1. **データは削除しない**: 退会時、PostgreSQLのユーザーレコードもkintoneの人材レコードも削除しません。STフィールドで論理削除を行います。

2. **エラーハンドリング**: kintoneへのアクセスに失敗した場合、ログインは許可されます（フェイルオープン）。

3. **再登録**: 退会したユーザーが同じメールアドレスで再登録する場合、PostgreSQLに既存レコードがあるためエラーになります。完全な再登録を可能にするには追加実装が必要です。
