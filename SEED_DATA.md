# シードデータ管理

このドキュメントでは、開発・テスト用のシードデータの作成・削除方法について説明します。

## 📋 シードデータの内容

- **Better Auth ユーザー**: 1 件

  - メール: `seed_yamada@example.com`
  - パスワード: `password123`
  - 名前: `山田 太郎`

- **kintone 人材 DB**: 1 件

  - 上記ユーザーと連携（auth_user_id）
  - 基本情報、スキル、希望条件を含む

- **kintone 案件 DB**: 5 件

  - 大手 EC サイトのフロントエンド刷新案件
  - 金融系 Web アプリケーション開発
  - スタートアップ向け新規サービス開発
  - 社内システムのリプレイス案件
  - 官公庁向けポータルサイト開発

- **kintone 応募履歴 DB**: 2 件
  - 山田太郎が 2 つの案件に応募済み
  - 対応状況: 「応募済み」「書類選考中」

## 🚀 シードデータ作成

```bash
# シードデータを作成
npm run seed:create
```

### 作成される内容

1. Better Auth にユーザー登録（メール認証済み）
2. kintone 人材 DB にレコード作成
3. kintone 案件 DB に 5 件のレコード作成
4. kintone 応募履歴 DB に 2 件のレコード作成

### 実行ログ例

```
================================================================================
👤 Step 1: Better Authユーザーを作成
================================================================================
✅ ユーザー作成: seed_yamada@example.com (ID: abc123...)

================================================================================
👨‍💼 Step 2: 人材DBにレコードを作成
================================================================================
✅ 人材レコード作成: 山田 太郎 (ID: 15)

================================================================================
💼 Step 3: 案件DBにレコードを作成
================================================================================
✅ 案件レコード作成: 大手ECサイトのフロントエンド刷新案件 (ID: 16)
✅ 案件レコード作成: 金融系Webアプリケーション開発 (ID: 17)
...

================================================================================
📝 Step 4: 応募履歴DBにレコードを作成
================================================================================
✅ 応募履歴レコード作成: auth_user_id=abc123..., 案件ID=16 (ID: 18)
✅ 応募履歴レコード作成: auth_user_id=abc123..., 案件ID=18 (ID: 19)
```

## 🗑️ シードデータ削除

```bash
# シードデータを削除
npm run seed:delete
```

### 削除される内容

1. kintone 応募履歴 DB のレコード削除
2. kintone 案件 DB のレコード削除
3. kintone 人材 DB のレコード削除
4. Better Auth のユーザーとセッションデータ削除

## 👤 個別ユーザー削除

```bash
# 特定のユーザーを削除（Better Auth + kintone）
npm run delete-user <メールアドレス>

# 例
npm run delete-user test@example.com
npm run delete-user seed_yamada@example.com
```

## 🧪 テスト用ユーザー作成

```bash
# ランダムなメールアドレスでテストユーザーを作成
npm run test-signup

# 指定したメールアドレスでテストユーザーを作成
npm run test-signup test@example.com
```

### テスト用ユーザー作成の流れ

1. Better Auth にユーザー登録
2. kintone 人材 DB にレコード作成
3. ログイン情報と削除コマンドを表示

## 📊 kintone フィールド情報取得

```bash
# 全アプリのフィールド一覧を取得
npm run get-fields
```

### 取得される情報

- 人材 DB（Talent）のフィールド一覧
- 案件 DB（Job）のフィールド一覧
- 応募履歴 DB（Application）のフィールド一覧

結果は `fields-data.json` に保存されます。

## ⚠️ 注意事項

### 環境変数の確認

シードデータ作成前に、以下の環境変数が設定されていることを確認してください：

```bash
# .env.local
KINTONE_BASE_URL=https://your-domain.cybozu.com
KINTONE_TALENT_APP_ID=81
KINTONE_JOB_APP_ID=85
KINTONE_APPLICATION_APP_ID=84
KINTONE_TALENT_API_TOKEN=your_talent_token
KINTONE_JOB_API_TOKEN=your_job_token
KINTONE_APPLICATION_API_TOKEN=your_application_token
```

### API トークンの権限

各 kintone アプリの API トークンに以下の権限が必要です：

- **レコード閲覧**: ✅
- **レコード追加**: ✅
- **レコード編集**: ✅
- **レコード削除**: ✅

### ルックアップフィールドの設定

応募履歴 DB のルックアップが正常に動作するため、以下の設定が必要です：

- 人材 DB の `auth_user_id` フィールド: 「値の重複を禁止する」を有効
- 案件 DB の `案件ID` フィールド: 「値の重複を禁止する」を有効

## 🔧 トラブルシューティング

### よくあるエラー

#### 1. 環境変数エラー

```
❌ KINTONE_BASE_URL が設定されていません
```

**解決方法**: `.env.local` ファイルに環境変数を設定してください。

#### 2. API トークンエラー

```
❌ [403] このAPIトークンでは、指定したAPIを実行できません。
```

**解決方法**: kintone アプリの設定で、API トークンに必要な権限を付与してください。

#### 3. ルックアップエラー

```
❌ [400] ルックアップの参照先から値をコピーできません。
```

**解決方法**: 参照元フィールドで「値の重複を禁止する」を有効にしてください。

#### 4. 重複ユーザーエラー

```
❌ User already exists. Use another email.
```

**解決方法**: 既存のユーザーを削除してから再作成してください。

```bash
npm run delete-user seed_yamada@example.com
npm run seed:create
```

## 📝 ログイン情報

### シードデータユーザー

- **メール**: `seed_yamada@example.com`
- **パスワード**: `password123`

このユーザーでログインすると、応募済み案件が 2 件表示されます。

### テストユーザー

`npm run test-signup` で作成したユーザーは、実行後に表示される情報でログインできます。

---

## 🔄 開発フロー例

```bash
# 1. 開発開始時：シードデータ作成
npm run seed:create

# 2. 開発中：テストユーザー作成
npm run test-signup

# 3. テスト後：不要なユーザー削除
npm run delete-user test@example.com

# 4. 開発終了時：全データ削除
npm run seed:delete
```
