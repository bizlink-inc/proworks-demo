name: Deploy Lambda

on:
  push:
    branches:
      - develop
      - main
    paths:
      - 'lambda/**'
      - '.github/workflows/deploy-lambda.yml'
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-1

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: lambda/package-lock.json

      # AWSèªè¨¼
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # SAM CLIã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      # ç’°å¢ƒå¤‰æ•°ã‚’æ±ºå®š
      - name: Set environment variables
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENV_NAME=prod" >> $GITHUB_ENV
            echo "LAMBDA_SECRET_NAME=proworks/lambda-prod" >> $GITHUB_ENV
            echo "LAMBDA_SECRETS_ARN=arn:aws:secretsmanager:ap-northeast-1:217797467306:secret:proworks/lambda-prod-eEUCKR" >> $GITHUB_ENV
          else
            echo "ENV_NAME=dev" >> $GITHUB_ENV
            echo "LAMBDA_SECRET_NAME=proworks/lambda-dev" >> $GITHUB_ENV
            echo "LAMBDA_SECRETS_ARN=arn:aws:secretsmanager:ap-northeast-1:217797467306:secret:proworks/lambda-dev-EhdHlz" >> $GITHUB_ENV
          fi

      # Secrets Managerã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—
      - name: Get secrets from Secrets Manager
        id: get-secrets
        run: |
          # Lambdaè¨­å®šã‚’å–å¾—
          LAMBDA_SECRETS=$(aws secretsmanager get-secret-value \
            --secret-id "${{ env.LAMBDA_SECRET_NAME }}" \
            --query SecretString --output text)

          echo "KINTONE_BASE_URL=$(echo $LAMBDA_SECRETS | jq -r '.KINTONE_BASE_URL')" >> $GITHUB_ENV
          echo "KINTONE_TALENT_API_TOKEN=$(echo $LAMBDA_SECRETS | jq -r '.KINTONE_TALENT_API_TOKEN')" >> $GITHUB_ENV
          echo "KINTONE_JOB_API_TOKEN=$(echo $LAMBDA_SECRETS | jq -r '.KINTONE_JOB_API_TOKEN')" >> $GITHUB_ENV
          echo "KINTONE_RECOMMENDATION_API_TOKEN=$(echo $LAMBDA_SECRETS | jq -r '.KINTONE_RECOMMENDATION_API_TOKEN')" >> $GITHUB_ENV
          echo "KINTONE_TALENT_APP_ID=$(echo $LAMBDA_SECRETS | jq -r '.KINTONE_TALENT_APP_ID')" >> $GITHUB_ENV
          echo "KINTONE_JOB_APP_ID=$(echo $LAMBDA_SECRETS | jq -r '.KINTONE_JOB_APP_ID')" >> $GITHUB_ENV
          echo "KINTONE_RECOMMENDATION_APP_ID=$(echo $LAMBDA_SECRETS | jq -r '.KINTONE_RECOMMENDATION_APP_ID')" >> $GITHUB_ENV

          # DATABASE_URLã‚’å–å¾—
          DATABASE_SECRETS=$(aws secretsmanager get-secret-value \
            --secret-id "proworks/database" \
            --query SecretString --output text)
          echo "DATABASE_URL=$(echo $DATABASE_SECRETS | jq -r '.url')" >> $GITHUB_ENV

      # Lambdaä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install Lambda dependencies
        working-directory: lambda
        run: |
          echo "ğŸ“¦ Package files:"
          ls -la package*.json
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed"

      # TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ« & ãƒ“ãƒ«ãƒ‰æº–å‚™
      - name: Build Lambda
        working-directory: lambda
        run: |
          npm run compile
          npm run prepare-build

      # SAMãƒ“ãƒ«ãƒ‰
      - name: SAM Build
        working-directory: lambda
        run: sam build

      # SAMãƒ‡ãƒ—ãƒ­ã‚¤
      - name: SAM Deploy
        working-directory: lambda
        run: |
          sam deploy \
            --config-env "${{ env.ENV_NAME }}" \
            --resolve-s3 \
            --capabilities CAPABILITY_IAM \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              "KintoneBaseUrl=${{ env.KINTONE_BASE_URL }}" \
              "KintoneTalentApiToken=${{ env.KINTONE_TALENT_API_TOKEN }}" \
              "KintoneJobApiToken=${{ env.KINTONE_JOB_API_TOKEN }}" \
              "KintoneRecommendationApiToken=${{ env.KINTONE_RECOMMENDATION_API_TOKEN }}" \
              "KintoneTalentAppId=${{ env.KINTONE_TALENT_APP_ID }}" \
              "KintoneJobAppId=${{ env.KINTONE_JOB_APP_ID }}" \
              "KintoneRecommendationAppId=${{ env.KINTONE_RECOMMENDATION_APP_ID }}" \
              "DatabaseUrl=${{ env.DATABASE_URL }}" \
              "LambdaSecretsArn=${{ env.LAMBDA_SECRETS_ARN }}"

      # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚’å‡ºåŠ›
      - name: Show deployment result
        run: |
          echo "ğŸš€ Deployed Lambda to AWS"
          echo "Environment: ${{ env.ENV_NAME }}"
          echo "Stack: proworks-recommend-batch-${{ env.ENV_NAME }}"
