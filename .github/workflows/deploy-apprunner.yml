name: Deploy to AWS App Runner

on:
  push:
    branches:
      - develop
      - main

env:
  AWS_REGION: ap-northeast-1
  AWS_ACCOUNT_ID: "217797467306"
  # ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒå¤‰æ•°
  KINTONE_BASE_URL: 'https://example.cybozu.com'
  KINTONE_TALENT_API_TOKEN: 'test-token'
  KINTONE_TALENT_APP_ID: '1'
  KINTONE_JOB_API_TOKEN: 'test-token'
  KINTONE_JOB_APP_ID: '2'
  KINTONE_APPLICATION_API_TOKEN: 'test-token'
  KINTONE_APPLICATION_APP_ID: '3'
  KINTONE_RECOMMENDATION_API_TOKEN: 'test-token'
  KINTONE_RECOMMENDATION_APP_ID: '4'
  NEXT_PUBLIC_APP_URL: 'http://localhost:3000'
  BETTER_AUTH_SECRET: 'test-secret-key-for-ci-must-be-32-chars-minimum'

jobs:
  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ãƒã‚§ãƒƒã‚¯ï¼‰
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript check
        run: npx tsc --noEmit

      - name: Run unit tests
        run: npm test

  deploy:
    runs-on: ubuntu-latest
    needs: test  # ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤

    steps:
      # ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # AWSèªè¨¼
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ECRãƒ­ã‚°ã‚¤ãƒ³
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ç’°å¢ƒåã¨ã‚µãƒ¼ãƒ“ã‚¹åã‚’æ±ºå®š
      - name: Set environment variables
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENV_NAME=prod" >> $GITHUB_ENV
            echo "SERVICE_NAME=proworks-prod" >> $GITHUB_ENV
            echo "ECR_REPOSITORY=proworks-prod" >> $GITHUB_ENV
            echo "APPRUNNER_SECRET_NAME=proworks/apprunner-prod" >> $GITHUB_ENV
          else
            echo "ENV_NAME=dev" >> $GITHUB_ENV
            echo "SERVICE_NAME=proworks-dev" >> $GITHUB_ENV
            echo "ECR_REPOSITORY=proworks-dev" >> $GITHUB_ENV
            echo "APPRUNNER_SECRET_NAME=proworks/apprunner-dev" >> $GITHUB_ENV
          fi

      # Secrets Managerã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—
      - name: Get secrets from Secrets Manager
        id: get-secrets
        run: |
          # App Runnerç”¨ã®ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—
          SECRETS=$(aws secretsmanager get-secret-value \
            --secret-id "${{ env.APPRUNNER_SECRET_NAME }}" \
            --query SecretString --output text)

          # JSONã‚’ç’°å¢ƒå¤‰æ•°å½¢å¼ã«å¤‰æ›ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "$SECRETS" | jq -r 'to_entries | .[] | "\(.key)=\(.value)"' > /tmp/env_vars.txt

          echo "âœ… Secrets Managerã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—ã—ã¾ã—ãŸ"

      # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
      - name: Build Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
        run: |
          docker build \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }} \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .

      # ECRã«ãƒ—ãƒƒã‚·ãƒ¥
      - name: Push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      # App Runnerã‚µãƒ¼ãƒ“ã‚¹ARNã‚’å–å¾—
      - name: Get App Runner service ARN
        id: get-service-arn
        run: |
          SERVICE_ARN=$(aws apprunner list-services \
            --query "ServiceSummaryList[?ServiceName=='${{ env.SERVICE_NAME }}'].ServiceArn" \
            --output text)
          echo "SERVICE_ARN=$SERVICE_ARN" >> $GITHUB_OUTPUT
          if [ -z "$SERVICE_ARN" ]; then
            echo "âŒ App Runnerã‚µãƒ¼ãƒ“ã‚¹ '${{ env.SERVICE_NAME }}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… App Runnerã‚µãƒ¼ãƒ“ã‚¹ARN: $SERVICE_ARN"

      # App Runnerã‚µãƒ¼ãƒ“ã‚¹ãŒæ›´æ–°å¯èƒ½ãªçŠ¶æ…‹ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
      - name: Wait for App Runner service to be ready
        env:
          SERVICE_ARN: ${{ steps.get-service-arn.outputs.SERVICE_ARN }}
        run: |
          echo "â³ App Runnerã‚µãƒ¼ãƒ“ã‚¹ãŒæ›´æ–°å¯èƒ½ãªçŠ¶æ…‹ã«ãªã‚‹ã¾ã§å¾…æ©Ÿä¸­..."
          MAX_WAIT=300  # æœ€å¤§5åˆ†å¾…æ©Ÿ
          ELAPSED=0
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(aws apprunner describe-service \
              --service-arn "$SERVICE_ARN" \
              --query "Service.Status" \
              --output text 2>/dev/null || echo "UNKNOWN")
            
            if [ "$STATUS" = "RUNNING" ]; then
              # é€²è¡Œä¸­ã®æ“ä½œãŒã‚ã‚‹ã‹ç¢ºèª
              OPERATIONS=$(aws apprunner list-operations \
                --service-arn "$SERVICE_ARN" \
                --max-results 1 \
                --query "OperationSummaryList[?Status=='IN_PROGRESS']" \
                --output json 2>/dev/null || echo "[]")
              
              if [ "$OPERATIONS" = "[]" ]; then
                echo "âœ… ã‚µãƒ¼ãƒ“ã‚¹ã¯æ›´æ–°å¯èƒ½ãªçŠ¶æ…‹ã§ã™"
                break
              fi
            fi
            
            echo "   ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $STATUS (${ELAPSED}ç§’çµŒé)"
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "âš ï¸  ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ã‚µãƒ¼ãƒ“ã‚¹ãŒæ›´æ–°å¯èƒ½ãªçŠ¶æ…‹ã«ãªã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi

      # App Runnerã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆã‚½ãƒ¼ã‚¹è¨­å®šã¨ç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°ï¼‰
      - name: Deploy to App Runner
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
          SERVICE_ARN: ${{ steps.get-service-arn.outputs.SERVICE_ARN }}
        run: |
          echo "ğŸš€ App Runnerã‚µãƒ¼ãƒ“ã‚¹ã‚’æ›´æ–°ä¸­..."

          # Secrets Managerã‹ã‚‰å–å¾—ã—ãŸç’°å¢ƒå¤‰æ•°ã‚’JSONå½¢å¼ã«å¤‰æ›
          ENV_VARS_JSON=$(cat /tmp/env_vars.txt | while IFS='=' read -r key value; do
            echo "{\"Name\":\"$key\",\"Value\":\"$value\"}"
          done | jq -s '.')

          # Secrets Manager ARNå‚ç…§ã®ç’°å¢ƒå¤‰æ•°ï¼ˆDATABASE_URL, GEMINI_API_KEYï¼‰
          # ã“ã‚Œã‚‰ã¯æ—¢å­˜ã®è¨­å®šã‹ã‚‰å–å¾—ã—ã¦ç¶­æŒ
          CURRENT_CONFIG=$(aws apprunner describe-service \
            --service-arn "$SERVICE_ARN" \
            --query 'Service.SourceConfiguration.ImageRepository.ImageConfiguration.RuntimeEnvironmentSecrets' \
            --output json 2>/dev/null || echo '{}')

          # ã‚½ãƒ¼ã‚¹è¨­å®šã‚’æ§‹ç¯‰
          SOURCE_CONFIG=$(cat <<EOF
          {
            "ImageRepository": {
              "ImageIdentifier": "$ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }}",
              "ImageRepositoryType": "ECR",
              "ImageConfiguration": {
                "Port": "8080",
                "RuntimeEnvironmentVariables": $ENV_VARS_JSON,
                "RuntimeEnvironmentSecrets": $CURRENT_CONFIG
              }
            }
          }
          EOF
          )

          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "$SOURCE_CONFIG" > /tmp/source-config.json

          # App Runnerã‚’æ›´æ–°
          aws apprunner update-service \
            --service-arn "$SERVICE_ARN" \
            --source-configuration file:///tmp/source-config.json

          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ"
          echo "   ã‚µãƒ¼ãƒ“ã‚¹: ${{ env.SERVICE_NAME }}"
          echo "   ã‚¤ãƒ¡ãƒ¼ã‚¸: $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }}"
          echo "   ç’°å¢ƒå¤‰æ•°: $(echo "$ENV_VARS_JSON" | jq 'length')ä»¶"

      # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚’å‡ºåŠ›
      - name: Show deployment result
        run: |
          echo "ğŸš€ Deployed to AWS App Runner"
          echo "Environment: ${{ env.ENV_NAME }}"
          echo "Service: ${{ env.SERVICE_NAME }}"
          echo "Image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"

