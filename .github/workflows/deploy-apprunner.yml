name: Deploy to AWS App Runner

on:
  push:
    branches:
      - develop
      - main

env:
  AWS_REGION: ap-northeast-1
  AWS_ACCOUNT_ID: "217797467306"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # AWSèªè¨¼
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ECRãƒ­ã‚°ã‚¤ãƒ³
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ç’°å¢ƒåã¨ã‚µãƒ¼ãƒ“ã‚¹åã‚’æ±ºå®š
      - name: Set environment variables
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENV_NAME=prod" >> $GITHUB_ENV
            echo "SERVICE_NAME=proworks-prod" >> $GITHUB_ENV
            echo "ECR_REPOSITORY=proworks-prod" >> $GITHUB_ENV
          else
            echo "ENV_NAME=dev" >> $GITHUB_ENV
            echo "SERVICE_NAME=proworks-dev" >> $GITHUB_ENV
            echo "ECR_REPOSITORY=proworks-dev" >> $GITHUB_ENV
          fi

      # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
      - name: Build Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
        run: |
          docker build \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }} \
            --tag $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .

      # ECRã«ãƒ—ãƒƒã‚·ãƒ¥
      - name: Push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }}
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      # App Runnerã‚µãƒ¼ãƒ“ã‚¹ARNã‚’å–å¾—
      - name: Get App Runner service ARN
        id: get-service-arn
        run: |
          SERVICE_ARN=$(aws apprunner list-services \
            --query "ServiceSummaryList[?ServiceName=='${{ env.SERVICE_NAME }}'].ServiceArn" \
            --output text)
          echo "SERVICE_ARN=$SERVICE_ARN" >> $GITHUB_OUTPUT
          if [ -z "$SERVICE_ARN" ]; then
            echo "âŒ App Runnerã‚µãƒ¼ãƒ“ã‚¹ '${{ env.SERVICE_NAME }}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… App Runnerã‚µãƒ¼ãƒ“ã‚¹ARN: $SERVICE_ARN"

      # App Runnerã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆã‚½ãƒ¼ã‚¹è¨­å®šã‚’æ›´æ–°ï¼‰
      - name: Deploy to App Runner
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
          SERVICE_ARN: ${{ steps.get-service-arn.outputs.SERVICE_ARN }}
        run: |
          echo "ğŸš€ App Runnerã‚µãƒ¼ãƒ“ã‚¹ã‚’æ›´æ–°ä¸­..."
          aws apprunner update-service \
            --service-arn "$SERVICE_ARN" \
            --source-configuration "{\"ImageRepository\":{\"ImageIdentifier\":\"$ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }}\",\"ImageRepositoryType\":\"ECR\",\"ImageConfiguration\":{\"Port\":\"8080\"}}}"

          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ"
          echo "   ã‚µãƒ¼ãƒ“ã‚¹: ${{ env.SERVICE_NAME }}"
          echo "   ã‚¤ãƒ¡ãƒ¼ã‚¸: $ECR_REGISTRY/$ECR_REPOSITORY:${{ github.sha }}"

      # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚’å‡ºåŠ›
      - name: Show deployment result
        run: |
          echo "ğŸš€ Deployed to AWS App Runner"
          echo "Environment: ${{ env.ENV_NAME }}"
          echo "Service: ${{ env.SERVICE_NAME }}"
          echo "Image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"

